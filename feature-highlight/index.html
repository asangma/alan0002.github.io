<!DOCTYPE html>
<html dir="ltr">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no" />
  <title>Feature Highlight</title>
  <link rel="stylesheet" href="https://jsdev.arcgis.com/4.1/esri/themes/light/main.css">
  <style>
    html,
    body,
    #sceneDiv {
      height: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
    }

    .options-widget {
        padding: 12px 15px;
    }
    .options-widget ul {
        padding: 0;
        margin: 0;
    }
    .options-widget li {
        list-style: none;
    }

    .esri-widget label {
      margin: 10px 0 0 0;
      display: block;
    }

    .esri-widget input {
      font-size: 12px;
      padding: 0.5em;
    }
  </style>
  <script>
    /*var dojoConfig = {
      paths: {
        "esri": "../esri"
      }
    };*/
  </script>
  <script src="https://jsdev.arcgis.com/4.1"></script>

  <script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha256-cCueBR6CsyA4/9szpPfrX3s49M9vUU5BgtiJj06wt/s=" crossorigin="anonymous"></script>
  <script type="text/javascript">
    var map, view, featureLayer, defNode;

    require([
        "esri/Map",
        "esri/views/MapView",

        "esri/layers/FeatureLayer",

        "esri/PopupTemplate",

        "dojo/dom-attr",

        "dojo/domReady!"
      ],
      function (
        Map, MapView,
        FeatureLayer,
        PopupTemplate,
        domAttr
      ) {

        map = new Map({
          basemap: "gray"
        });

        view = new MapView({
          container: "sceneDiv",
          map: map,
          center: [-73.950, 40.702],
          zoom: 11
        });

        view.popup.dockOptions = {
          position: "bottom-center"
        };

        /********************
         * Add feature layer
         ********************/

        //Create the PopupTemplate
        var tpl = new PopupTemplate({
          title: "Marriage in NY, Zip Code: {ZIP}",
          content: "<p><b> Marriage Rate: {MARRIEDRATE}% </b></p>" +
            "<p> Married: {MARRIED_CY}</p>" +
            "<p> Never Married: {NEVMARR_CY}</p>" +
            "<p> Divorced: {DIVORCD_CY}</p>"
        });

        //Create the FeatureLayer using the popupTemplate
        featureLayer = new FeatureLayer({
          url: "http://services.arcgis.com/V6ZHFr6zdgNZuVG0/ArcGIS/rest/services/NYCDemographics1/FeatureServer/0",
          outFields: ["*"],
          popupTemplate: tpl
        });
        map.add(featureLayer);

       /* view.whenLayerView(featureLayer).then(function(layerView) {
          window.layerView = layerView;

          // console.dir(layerView._graphicsView.group);
          // var svgDefNode = layerView._graphicsView.group.surface.parent.defNode;
        });*/

        featureLayer.then(function(evt){
          setTimeout(function(){
            defNode = jQuery('defs')[0];
            jQuery(defNode).load('includes/svg-defs.html');
          }, 3000);
        });

        view.on('click', function(evt){
          jQuery('.curr_svg_node').each(function(index){
            jQuery(this).attr('filter', '');
            jQuery(this).removeClass('curr_svg_node');
          });

          var uid = view.popup.selectedFeature.uid;
          var vector = view.layerViews.items[0]._graphicsView._vectors[uid].shape.getNode();

          jQuery(vector).attr('filter', 'url(#highlight)');
          jQuery(vector).addClass('curr_svg_node');
          jQuery(vector).parent().append(jQuery(vector));
        });

        view.ui.add(jQuery('.options-widget')[0], 'top-right');

      });
      // var colors = {
      //   black : '0, 0, 0',
      //   white : '255, 255, 255',

      // }
      var curr_color, curr_alpha;

      jQuery(document).ready(function() {
        curr_alpha = jQuery('input[name="opacity"').val();
        curr_color = jQuery('.color_select option:selected').attr('data-color');

        jQuery('input[name="spread"').change(function(){
          jQuery('#spread').attr('radius', jQuery(this).val());
        });
        jQuery('input[name="blur"').change(function(){
          jQuery('#blur').attr('stdDeviation', jQuery(this).val());
        });
        jQuery('input[name="opacity"').change(function(){
          curr_alpha = jQuery(this).val();
          jQuery('#color').attr('flood-color', 'rgba('+ curr_color +', '+ curr_alpha +')');
        });

        jQuery('.color_select').change(function(){
          curr_color = jQuery('.color_select option:selected').attr('data-color');
          jQuery('#color').attr('flood-color', 'rgba('+ curr_color +', '+ curr_alpha +')');
        });
      });
  </script>

</head>

<body>
  <div id="sceneDiv"></div>
  <div class="options-widget esri-widget">
    <h4>Configure Highlight</h4>
    <label class="esri-clearfix" for="spread">Spread</label>
    <input type="number" name="spread" value="4">

    <label class="esri-clearfix" for="blur">Blur</label>
    <input type="number" name="blur" value="0">

    <label class="esri-clearfix" for="opacity">Opacity</label>
    <input type="number" name="opacity" value="0.85">

    <label class="esri-clearfix" for="color">Color</label>
    <select name="color" class="color_select">
      <option value="black" data-color="0, 0, 0" selected="selected">Black</option>
      <option value="white" data-color="255, 255, 255">White</option>
      <option value="blue" data-color="0, 122, 194">Blue</option>
      <option value="purple" data-color="241, 133, 255">Purple</option>
      <option value="orange" data-color="255, 100, 46">Orange</option>
      <option value="yellow" data-color="255, 240, 0">Yellow</option>
      <option value="red" data-color="222, 41, 0">Red</option>
    </select>
  </div>
</body>

</html>