<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>hitTest</title>

  <link href="../../esri/css/view.css" rel="stylesheet" type="text/css">

  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
    }
    body {
      font-family: source-sans-pro, sans-serif;
      position: relative;
      overflow: hidden;
    }
    #map {
      width: 100%;
      height: 100%;
    }
  </style>

  <!-- helper to setup jsapi -->
  <script src="./jsapi.js"></script>
  <script src="../../dojo/dojo.js"></script>

  <script type="text/javascript">
  var map, view, camSF, camLatvia;

  jsAPI.setup(function() {
    require([
      "dojo/_base/lang",
      "dojo/on", "dojo/promise/all", "dojo/dom", "dojo/Deferred",
      "esri/kernel", "esri/config",

      "esri/Map", "esri/views/SceneView", "esri/Camera",
      "esri/geometry/Extent",
      "esri/layers/FeatureLayer",
      "esri/layers/GraphicsLayer",
      "esri/layers/SceneLayer",
      "esri/layers/support/LabelClass",

      "esri/Graphic",


      "esri/renderers/SimpleRenderer",
      "esri/symbols/PointSymbol3D",
      "esri/symbols/IconSymbol3DLayer"

    ], function(
      lang, on, all, dom, Deferred,
      esriNS, esriConfig,
      Map, SceneView, Camera, Extent, FeatureLayer, GraphicsLayer, SceneLayer, LabelClass,
      Graphic,
      SimpleRenderer,
      PointSymbol3D, IconSymbol3DLayer
    ) {

      map = new Map({
        basemap: "topo"
      });

      view = new SceneView({
        container: dom.byId("map"),
        map: map
      });

      var tLayer = new GraphicsLayer({ elevationInfo: {mode:"absoluteHeight"}});
      map.add(tLayer);

      var featLayer = new FeatureLayer("http://services.arcgis.com/nzS0F0zdNLvs7nc8/arcgis/rest/services/05_HurricaneAndrew_1992/FeatureServer/0", {
        mode: FeatureLayer.MODE_SNAPSHOT
      });
      map.add(featLayer);

      var symbol = new PointSymbol3D({
        symbolLayers: [{
          type: "Object",
          width: 1000,
          height: 100000,
          resource: {
            primitive: "cylinder"
          },
          material: {
            color: [255, 0, 0]
          }
        }]
      });

      var renderer = new SimpleRenderer(symbol);
      renderer.setVisualVariables([{
        "type": "colorInfo",
        "field": "WIND_KTS",
        "minDataValue": 20,
        "maxDataValue": 150,
        "colors": [
          [
            0,
            0,
            255
          ],
          [
            255,
            0,
            0
          ]
        ]
      }, {
        "type": "sizeInfo",
        "field": "WIND_KTS",
        "minDataValue": 20,
        "maxDataValue": 150,
        "minSize": 60000,
        "maxSize": 450000,
        "axis": "height"
      }, {
        "type": "sizeInfo",
        "minSize": 50000,
        "axis": "width"
      }]);

      featLayer.set("renderer", renderer);

      map.add(new FeatureLayer("http://services.arcgis.com/V6ZHFr6zdgNZuVG0/arcgis/rest/services/CITIES_EastUSA_range/FeatureServer/0", {
        mode: FeatureLayer.MODE_SNAPSHOT
      }));

      var tSymbol = new PointSymbol3D(new IconSymbol3DLayer({
          type: "Icon",
          size: 24,
          resource: {
            primitive: "cross"
          },
          material: {
            color: [255, 0, 0]
          }
      }));

      /*var tSymbol2 = new PointSymbol3D({
        symbolLayers: [{
          type: "Icon",
          size: 24,
          resource: {
            primitive: "x"
          },
          material: {
            color: [255, 0, 0]
          }
        }]
      });
      
      var tSymbol3 = new PointSymbol3D({
        symbolLayers: [{
          type: "Icon",
          size: 24,
          resource: {
            primitive: "kite"
          },
          material: {
            color: [255, 0, 0]
          }
        }]
      });*/

      var tRenderer = new SimpleRenderer(tSymbol);
      //var tRenderer = new UniqueValueRenderer(tSymbol, "lbl");

      tLayer.set("renderer", tRenderer);
      tLayer.set("labelingInfo", [new LabelClass({
        "labelExpression": "[lbl]",
        "labelPlacement": "esriServerPointLabelPlacementAboveCenter",
        "symbol": {
          "type": "LabelSymbol3D",
          "symbolLayers": [{
            "size": 8,
            "type": "Text",
            "material": {
              "color": [255, 0, 0],
              "transparency": 50
            },
            "font": {
              "family": "Arial",
              //"style": "italic",
              "weight": "bold"
            },
            "text": "default"
          }]
        }
      })]);

      tLayer.set("showLabels", true);

      //ssl
      camSF = Camera.fromJson({"position":{"x":-13621373.551230632,"y":4543325.473634791,"z":3310.7600526781753,"spatialReference":{"wkid":102100,"latestWkid":3857}},"heading":324.5590300965281,"tilt":61.13772476226095,"fov":48.05794917059202});

      map.add(new SceneLayer("http://zrh-arcgis-ser2.esri.com/arcgis/rest/services/Hosted/sf_downtown_900/SceneServer/layers/0"));

      // poly feats, draped
      map.add(new FeatureLayer("http://services.arcgis.com/Lu4fDrZtZJVYIIZX/ArcGIS/rest/services/PrezRink02_1tur/FeatureServer/0", {
        mode: FeatureLayer.MODE_SNAPSHOT
      }));

      //poly feats vector
      map.add(new FeatureLayer("http://services.arcgis.com/Lu4fDrZtZJVYIIZX/ArcGIS/rest/services/PrezRink02_1tur/FeatureServer/0", {
        mode: FeatureLayer.MODE_SNAPSHOT,
        elevationInfo :{
          mode:"relativeToGround",
          offset: 10000
        }
      }));

      camLatvia = Camera.fromJson({"position":{"x":2231740.385775301,"y":6753291.530777624,"z":235315.48807549197,"spatialReference":{"wkid":102100,"latestWkid":3857}},"heading":36.004494179116016,"tilt":59.86095413101146,"fov":48.05794917059202});    

      on(dom.byId("map"), "click", function(e) {
        //console.log(e);
        var screenPoint = {
          x: e.x,
          y: e.y
        };

        var pixelSize = view.pixelSizeAt(screenPoint);
        console.log("pixelSize: ", pixelSize);
        dom.byId("out2").innerHTML = "pixelSize: " + pixelSize;

        view.hitTest(screenPoint).then(function(res) {
          console.log("mapPoint: ", res.mapPoint);
          console.log("graphic: ", res.graphic);

          dom.byId("out").innerHTML = "mapPoint: " + JSON.stringify(res.mapPoint) + "<br>";

          if (res.graphic) {
            dom.byId("out3").innerHTML = "graphic: " + res.graphic.id + "," + (res.graphic.layer ? res.graphic.layer.name : "(unknown)") + "<br>&nbsp;" + JSON.stringify(res.graphic.attributes);
            res.graphic.attributes.lbl = "graphic";
            tLayer.add(res.graphic);

            var hitMappointGraphic = new Graphic(res.mapPoint, null, {
              "lbl": "mapHit"
            });

            tLayer.add(hitMappointGraphic);
          } else {
            var toMap = view.toMap(screenPoint);
            console.log("toMap: ", toMap);

            dom.byId("out3").innerHTML += "toMap: " + JSON.stringify(toMap);

            var tomapGraphic = new Graphic(toMap, null, {
              "lbl": "toMap"
            });

            tLayer.add(tomapGraphic);
          }
        });
        tLayer.set("renderer", tRenderer);
      });


      on(dom.byId("shLayers"), "change", function(e) {
        map.layers.getAll().forEach(function(l, i) {
          if(i>2){
            l.set("visible", e.srcElement.checked);
          }
        });
      });
    });
  });
  </script>
</head>

<body class="dark">
  <div id="map" style="width:1024px;height: 768px; display:inline-block"></div>
  <div>
  <input type="button" onclick="view.set('camera', camSF)" value="SF SSL-meshpyra"></input>
  <input type="button" onclick="view.set('camera', camLatvia)" value="Latvia Polies"></input>
  <div>
  
  <br>
  <input id="shLayers" type="checkbox" checked="checked">Show/hide data layers</input>
  <pre id="out"></pre>
  <pre id="out2"></pre>
  <pre id="out3"></pre>

</body>

</html>
