<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Map Sync</title>

  <link href="../../esri/css/main.css" rel="stylesheet" type="text/css">
  <link href="./map-sync.css" rel="stylesheet" type="text/css">

  <!-- helper to setup jsapi -->
  <script src="./jsapi.js"></script>
  <script src="../../dojo/dojo.js"></script>

  <script type="text/javascript">

  var views, view;

  jsAPI.setup([
    "dojo/_base/lang",
    "dojo/on", "dojo/promise/all", "dojo/dom", "dojo/Deferred", "dojo/query", "dojo/dom-style",
    "esri/kernel","esri/config",

    "esri/Map",
    "esri/views/MapView",
    "esri/views/SceneView",

    "esri/core/watchUtils",
    "esri/geometry/SpatialReference",

    "debugUtils/ExtentVisualizer"
  ], function(
    lang, on, all, dom, Deferred, query, domStyle,
    esriNS, esriConfig,
    Map, MapView, SceneView,
    watchUtils, SpatialReference,
    ExtentVisualizer
  ) {
    var initialExtent = {
      xmin: 618816.6043725822,
      ymin: 5392531.92105754,
      xmax: 1241993.8906600943,
      ymax: 6357493.417085142,
      spatialReference: SpatialReference.WebMercator
    };

    function createMapView(container) {
      return new MapView({
        map: new Map({
          basemap: "topo"
        }),
        container: container,
        extent: initialExtent,
        constraints: {
          snapToZoom: false
        }
      });
    }

    function createSceneView(container) {
      return new SceneView({
        map: new Map({
          basemap: "topo"
        }),
        container: container,
        extent: initialExtent
      });
    }

    var ss = document.location.search;
    var t1 = "2d", t2 = "3d";

    if (!ss) {
      var parts = ss.split("-");

      t1 = parts[0];

      if (parts.length === 1) {
        t2 = parts[0];
      } else {
        t2 = parts[1];
      }
    }

    views = {
      left: t1 === "2d" ? createMapView("mapLeft") : createSceneView("mapLeft"),
      right: t2 === "2d" ? createMapView("mapRight") : createSceneView("mapRight")
    };

    var ev1;
    var ev2;
    var evTimeout = 0;

    function updateExtentVisualization() {
      if (evTimeout) {
        clearTimeout(evTimeout);
      }

      evTimeout = setTimeout(function() {
        if (dom.byId("visualizeExtent").checked && ev1 && ev2) {
          ev1.update();
          ev2.update();
        }

        evTimeout = 0;
      }, 300);
    }

    function updateActiveView(target) {
      view = target;
    }

    function viewEnter(target) {
      if ((!view || !view.interacting) && view !== target) {
        if (view) {
          view.container.classList.remove("active");
        }

        view = target;
        view.container.classList.add("active");
      }
    }

    function syncView(newValue, oldValue, propName, source) {
      var dest = otherView(source);

      if (view === source && dom.byId("synchronizeViews").checked) {
        if (dest instanceof SceneView && source instanceof SceneView) {
          dest.camera = source.camera.clone();
        } else {
          dest.extent = source.extent;
        }
      }

      updateExtentVisualization();
    }

    function otherView(view) {
      return view === views.left ? views.right : views.left;
    }

    function setupView(view) {
      view.then(function() {
        var other = otherView(view);

        view.extent = other.extent;

        on(view.container, "mousemove", viewEnter.bind(this, view));
        watchUtils.when(view, "interacting", updateActiveView.bind(this, view));

        view.watch("extent", syncView);

        if (view instanceof SceneView) {
          if (ev1) {
            ev1.remove();
          }

          ev1 = new ExtentVisualizer(view, {
            color: [200, 0, 0, 0.25],
            extentFrom: other
          });

          if (ev2) {
            ev2.remove();
          }

          ev2 = new ExtentVisualizer(view, {
            color: [0, 200, 0, 0.25],
            extentFrom: view
          });

          updateExtentVisualization();
        }
      });
    }

    setupView(views.left);
    setupView(views.right);

    on(dom.byId("gridLines"), "change", function(e) {
      var display = e.srcElement.checked ? "" : "none";
  
      query(".grid").forEach(function(n) {
        domStyle.set(n, "display", display);
      });
    });

    on(dom.byId("visualizeExtent"), "change", function(e) {
      if (e.srcElement.checked) {
        updateExtentVisualization();
      }
    });

    on(dom.byId("syncLeft"), "click", function() {
      dom.byId("synchronizeViews").checked = false;
      views.left.extent = views.right.extent;

      updateExtentVisualization();
    });

    on(dom.byId("syncRight"), "click", function() {
      dom.byId("synchronizeViews").checked = false;
      views.right.extent = views.left.extent;

      updateExtentVisualization();
    });

    on(dom.byId("planarMode"), "change", function(e) {
      var isPlanar = e.srcElement.checked;

      if (views.right instanceof SceneView) {
        views.right.globeMode = isPlanar ? "planar" : "spherical";
      } else if (views.left instanceof SceneView) {
        views.left.globeMode = isPlanar ? "planar" : "spherical";
      }
    });

    // on(dom.byId("leftViewType"), "change", changeViewType.bind(this, "left"));
    // on(dom.byId("rightViewType"), "change", changeViewType.bind(this, "right"));

    // function changeViewType(side, ev) {
    //   var Clazz = ev.srcElement.value === "2d" ? MapView : SceneView;
    //   var container = views[side].container.id;

    //   views[side].destroy();

    //   views[side] = new Clazz(lang.mixin({
    //     extent: otherView(views[side]).extent,
    //     container: container
    //   }, props));

    //   setupView(views[side]);
    // }
  });
  </script>
</head>

<body>
  <div id="mapLeft">
    <div class="grid vertical"></div>
    <div class="grid horizontal"></div>
  </div>

  <div id="mapRight">
    <div class="grid vertical"></div>
    <div class="grid horizontal"></div>
  </div>

  <div id="controls">
    <table>
      <tr>
        <td>Update visible extent:</td>
        <td><input type="checkbox" id="visualizeExtent" checked></td>
      </tr>
      <tr>
        <td>Synchronize views:</td>
        <td><input type="checkbox" id="synchronizeViews" checked></td>
      </tr>
      <tr>
        <td>Show grid lines:</td>
        <td><input type="checkbox" id="gridLines" checked></td>
      </tr>
      <tr>
        <td>3D planar mode:</td>
        <td><input type="checkbox" id="planarMode"></td>
      </tr>
      <!-- <tr>
        <td>Left view type:</td>
        <td>
          <select id="leftViewType">
            <option value="2d">2D</option>
            <option value="3d">3D</option>
          </select>
        </td>
      </tr>
      <tr>
        <td>Right view type:</td>
        <td>
          <select id="rightViewType">
            <option value="2d">2D</option>
            <option value="3d" selected>3D</option>
          </select>
        </td>
      </tr> -->
      <tr>
        <td colspan="2">
          <button id="syncLeft">⇦ Sync ▣</button>
          <button id="syncRight">▣ Sync ⇨</button>
        </td>
      </tr>
    </table>
  </div>
</body>

</html>
