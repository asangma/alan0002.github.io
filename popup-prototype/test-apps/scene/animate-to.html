<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Map Sync</title>

  <link href="../../esri/css/view.css" rel="stylesheet" type="text/css">

  <style>
  html,
  body {
    margin: 0;
    padding: 0;
    height: 100%;
  }
  body {
    font-family: source-sans-pro, sans-serif;
    position: relative;
    overflow: hidden;
  }
  #map {
    width: 100%;
    height: 100%;
  }
  </style>

  <script src="./jsapi.js"></script>
  <script src="../../dojo/dojo.js"></script>

  <script type="text/javascript">
  var map, view;

  jsAPI.setup([
    "dojo/_base/lang",
    "dojo/on", "dojo/promise/all", "dojo/dom", "dojo/Deferred", "dojo/query", "dojo/dom-style",
    "esri/kernel","esri/config",

    "esri/Map", "esri/views/SceneView",
    "esri/geometry/Extent",
    "debugUtils/ExtentVisualizer",
    "esri/layers/ArcGISTiledLayer",
    "esri/layers/ArcGISElevationLayer",

    "esri/symbols/PointSymbol3D",
    "esri/symbols/ObjectSymbol3DLayer",
    "esri/geometry/Point",
    "esri/Graphic",
    "esri/layers/GraphicsLayer"
  ], function(
    lang, on, all, dom, Deferred, query, domStyle,
    esriNS, esriConfig,
    Map, SceneView, Extent, ExtentVisualizer,
    ArcGISTiledMapServiceLayer, ArcGISElevationLayer,

    PointSymbol3D, ObjectSymbol3DLayer, Point, Graphic, GraphicsLayer
  ) {
    map = new Map({
      basemap: "topo"
    });

    view = new SceneView({
      container: "map",
      map: map
    });

    all([map, view]).then(function() {
      var options = {
        color: [196, 0, 0]
      };

      var sym1 = new PointSymbol3D();
      var symLayer1 = new ObjectSymbol3DLayer({
        material: {
          color: options.color
        },
        elevationInfo: {mode: "absoluteHeight"},
        resource: {
          primitive: "sphere"
        },
        width: 200
      });

      var sym2 = new PointSymbol3D();
      var symLayer2= new ObjectSymbol3DLayer({
        material: {
          color: [0, 200, 0]
        },
        elevationInfo: {mode: "absoluteHeight"},
        resource: {
          primitive: "cube"
        },
        width: 200
      });

      sym1.addLayer(symLayer1);
      sym2.addLayer(symLayer2);

      var geometry = Point.fromJSON({"x":936012.1497948533,"y":5823732.172563503,"z":3000,"spatialReference":{"wkid":3857}});

      var layer = new GraphicsLayer({title: "Cool Spheres Layer"});

      var pts = [
        [-1, -1, 0],
        [ 1, -1, 1],
        [ 1,  1, 1],
        [-1,  1, 0],
        [ 0,  0, 0.5]
      ];

      var dx = 2000;
      var dy = 1000;
      var dz = 400;

      var gs = [];

      for (var i = 0; i < pts.length; i++) {
        var p = pts[i];

        var g = geometry.clone();
        g.x += dx * p[0];
        g.y += dy * p[1];
        g.z += dz * p[2];

        var graphic = new Graphic(g, i % 2 === 0 ? sym1 : sym2, {});
        layer.add(graphic);

        gs.push(graphic);
      }

      map.add(layer);

      view.animateTo({
        target: gs,
        scale: 20000,
        heading: 30,
        tilt: 60
      });

      var gi = 0;

      function animate(options) {
        view.animateTo({
          target: gs[gi],
          scale: 20000,
          heading: -45 - 90 * (gi - 1),
          tilt: 60 * Math.sin(gi / gs.length * Math.PI) + 10
        }, options || {}).then(function(animation) {
          if (animation.state === "stopped") {
            return;
          }

          gi = (gi + 1) % gs.length;
          animate({ delay: 1000 });
        });
      }

      window.animate = animate;

      view.animateTo(gs, {
        heading: 0,
        tilt: 0
      });

      var handle = on.pausable(dom.byId("animateButton"), "change", function(ev) {
        if (ev.srcElement.checked) {
          animate();
        } else {
          var animation = view.get("animation");

          if (animation) {
            animation.stop();
          }
        }
      });

      view.watch("animation", function(animation) {
        handle.pause();
        dom.byId("animateButton").checked = (animation !== null);
        handle.resume();
      });
    });
  });
  </script>
</head>

<body class="dark">
  <div style="width:600px;display:inline-block;">
    <div id="map" style="width:1024px;height: 768px; display:inline-block; position:relative;">
      <div class="grid" style="position:absolute; top:50%;height:1px;width:100%;background-color:#ff0000;z-index:100"></div>
      <div class="grid" style="position:absolute; left:50%;height:100%;width:1px;background-color:#ff0000;z-index:101"></div>
    </div>
    <input type="checkbox" id="animateButton"/> Animate?
  </div>
</body>

</html>
