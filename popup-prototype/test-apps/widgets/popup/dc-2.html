<!DOCTYPE html>
<html dir="ltr">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no" />
  <title>Popup</title>
  
  <!-- <link rel="stylesheet" href="../../../dijit/themes/claro/claro.css"> -->
  <link rel="stylesheet" href="../../../esri/css/main.css">
  <link rel="stylesheet" type="text/css" href="../../../esri/css/calcite/calcite.css">
  <style>
    html,
    body,
    #sceneDiv {
      height: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
    }
  </style>
  <script>
    var dojoConfig = {
      //async: true,
      //Debug: true,
      paths: {
        "esri": "../esri"
      }
    };
  </script>
  <script src="../../../dojo/dojo.js"></script>
  <script type="text/javascript">
    var map, view, popup, features, dcFL, ripple, tabHandler;
    var testing = true;

    require([
        "esri/Map",
        "esri/views/MapView",
        "dojo/dom-class",
        "dojo/dom",
        "dojo/on",
        "dojo/dom-attr",
        "dojo/window",
        "esri/tasks/QueryTask",
        "esri/tasks/support/Query",
        "esri/layers/FeatureLayer",
        "esri/layers/GraphicsLayer",
        "esri/Graphic",
        "esri/geometry/Extent",
        "esri/geometry/Point",
        "esri/symbols/SimpleMarkerSymbol",
        "esri/symbols/PictureMarkerSymbol",
        "esri/PopupTemplate",
        "esri/widgets/Popup",
        "esri/widgets/Popup/PopupRenderer",
        "esri/widgets/Ripple",
        "dojo/dom-construct",
        "dojo/Deferred",
        //"esri/symbols/SimpleMarkerSymbol",
        "dojo/domReady!"
    ], function (Map, MapView, domClass, dom, on, domAttr, win,
      QueryTask,
      Query,
      FeatureLayer,
      GraphicsLayer,
      Graphic,
      Extent,
      Point,
      SimpleMarkerSymbol,
      PictureMarkerSymbol,
      PopupTemplate,
      Popup,
      PopupRenderer,
      Ripple,
      domConstruct,
      Deferred
      //SimpleMarkerSymbol
    ) {
      //var $ = jQuery.noConflict();
      //Create the map
      map = new Map({
        basemap: "topo"
      });


      //Create the MapView
      view = new MapView({
        container: "sceneDiv",
        map: map,
        center: [-77.02512833211676, 38.890752845456115],
        zoom: 16
      });

      popup = new Popup({
        //position: "right",
        view: view
      });
      popup.startup();
      view.popup = popup;
/*
      ripple = new Ripple({
        visible: true,
        view: view
      });
      ripple.startup();
      domConstruct.place(ripple.domNode, view.root);*/
        /*

                    washington_monument: 867,
                    lincoln_memorial: 1213,
                    ww2: 768
        */

      var fieldInfos = [
        {
          fieldName     :'washington_monument',
          label         :'Washington Monument - Visitors',
          visible       :true
        },
        {
          fieldName     :'lincoln_memorial',
          label         :'Lincoln Memorial - Visitors',
          visible       :true
        },
        {
          fieldName     :'ww2',
          label         :'World War II Memorial - Visitors',
          visible       :true
        }
      ];
      var mediaInfos = [
          {
            "title": "Lincoln Memorial",
            "caption": "Lincoln Memorial",
            "type": "image",
            "value": {
              "sourceURL": "https://upload.wikimedia.org/wikipedia/commons/1/13/Wwiimemorial.jpg"/*,
              "linkURL": "{link}"*/
            }
          },
          {
            "title": "Washington Monument",
            "caption": "Washington Monument",
            "type": "image",
            "value": {
              "sourceURL": "http://www.digital-images.net/Images/Washington_DC/Washington_Monument/WashingtonMonument_LincolnPool_2813.jpg"/*,
              "linkURL": "{link}"*/
            }
          },
          {
            "title": "The White House",
            "caption": "The White House",
            "type": "image",
            "value": {
              "sourceURL": "http://cnsnews.com/sites/default/files/images/WHITE%20HOUSE-AP%20PHOTO-USE.jpg?1331589459",
              "linkURL": ""
            }
          },
          {
            "title": "The White House - Interior",
            "caption": "The White House - Interior",
            "type": "image",
            "value": {
              "sourceURL": "http://images.politico.com/global/2013/02/28/130227_oval_office_reuters_600_605.jpg",
              "linkURL": ""
            }
          },
          {
            "title": "World War II Memorial",
            "caption": "World War II Memorial",
            "type": "image",
            "value": {
              "sourceURL": "http://voices.washingtonpost.com/capitalweathergang/images/IMG_6214.jpg"/*,
              "linkURL": "{link}"*/
            }
          }/*,
          {
            "title": null,
            "type": "barchart",
            "caption": "",
            "value": {
              "fields": ["washington_monument", "tacos", "quesadillas"]
            }
          }*/
        ];
      var tpl = new PopupTemplate({
        title: "{title}",
        content: "{description}",
        mediaInfos: mediaInfos,
        //fieldInfos: fieldInfos,
        showAttachments: true
      });

      //var offOpacity = 1;

      //Create the FeatureLayer using the popupTemplate
      dcFLPoints = new FeatureLayer({
        popupTemplate   :tpl,
        url             : "http://services.arcgis.com/ZAA95z0SYTDJP9yw/arcgis/rest/services/DC_Point_FS/FeatureServer/0",
        //url             :'http://services.arcgis.com/ZAA95z0SYTDJP9yw/arcgis/rest/services/FL_Lincoln_Memorial/FeatureServer/0',
        outFields       : ["*"],
        PopupTemplate   :tpl
      });
      /*dcFLPoly = new FeatureLayer({
        popupTemplate   :tpl,
        url             : "http://services.arcgis.com/ZAA95z0SYTDJP9yw/arcgis/rest/services/FL_Lincoln_Memorial/FeatureServer/3",
        outFields       : ["*"]
      });
      dcFLPoly.opacity = 0;*/

      map.add(dcFLPoints);
      // map.add(dcFLPoly);

      view.on('click', function (event) {
        /*if (event.graphic) {
          features = [event.graphic];
          var def = new Deferred();

          setTimeout(function () {
            def.resolve(features);
          }, 1000);

          popup.set({
            promises: [def.promise],
            location: event.mapPoint
          });

        } else {

        }*/


      
        var features = [];
        var def = new Deferred();

        if (event.graphic) {
          var title = event.graphic.attributes.TITLE.toLowerCase();
          if(title.indexOf('multi') >= 0) {

          var pr = new PopupRenderer({graphic: event.graphic});
          var attachments = pr.getAttachments();
            features = [
              event.graphic,
              new Graphic({
                geometry: event.mapPoint,
                symbol: new SimpleMarkerSymbol(),
                attributes: {
                  title: "Concerts on the West Steps",
                  description: tableDataStrBand,
                  attachments: attachments
                },
                popupTemplate: tpl
              }),
              new Graphic({
                geometry: event.mapPoint,
                symbol: new SimpleMarkerSymbol(),
                attributes: {
                  title: "U.S. Capitol Building",
                  description: usCapitol,
                  attachments: attachments
                },
                popupTemplate: tpl
              }),
              new Graphic({
                geometry: event.mapPoint,
                symbol: new SimpleMarkerSymbol(),
                attributes: {
                  title: "U.S. Capitol Building Grounds",
                  description: lawnStr,
                  attachments: attachments
                },
                popupTemplate: tpl
              })
            ];
          } else {
            features = [
                event.graphic
            ];
          }
        } 
        ////////////////////
        //  IS TESTING?
        
        if(testing) {
          popup.set({features:features});
          resetTabs();
          connectTabs();/*

          var pr = new PopupRenderer({graphic: event.graphic});
          var attachments = pr.getAttachments();
          attachments.then(
            function(event){
              console.dir(event);
            },
            function(event){
              console.log('attachments fail');
            });
          console.dir(attachments);*/

        } else {
          setTimeout(function () {
            def.resolve(features);
            resetTabs();
            connectTabs();
          }, 1000);

          popup.set({
            promises: [def.promise],
            location: event.mapPoint
          });/*
          resetTabs();
          connectTabs();*/
        }

        if(ripple) ripple.destroy();
        ripple = new Ripple({
          visible: true,
          view: view
        });
        ripple.startup();
        domConstruct.place(ripple.domNode, view.root);
        ripple.set("visible", true);
        ripple.set("point", event.mapPoint);
      });


    });
function connectTabs() {
  dojo.addClass(dojo.query('.esri-popup-renderer-attachments')[0], 'esri-hidden');
  if(!tabHandler) {
    var tabTriggers = dojo.query('.esri-tab-title');
    for(var i = 0; i < tabTriggers.length; i++) {
      dojo.connect(tabTriggers[i], "onclick", function(event){
        var target = dojo.attr(this, 'data-toggle');
        var tabbedContent = dojo.query('.esri-tab-content');
        resetTabs(tabbedContent, target, tabTriggers, this);
      });
    }
    tabHandler = true;
  } else {
    console.log('Tabs already connected.');
    resetTabs();
  }
}

function resetTabs(tabbedContent, target, tabTriggers, currTab) {
    tabbedContent = tabbedContent ? tabbedContent : dojo.query('.esri-tab-content');
    tabTriggers = tabTriggers ? tabTriggers : dojo.query('.esri-tab-title')
    
    for(var i = 0; i < tabbedContent.length; i++) {
      dojo.addClass(tabbedContent[i], 'esri-hidden');
    }
    if(target) {
      console.log(target);
      dojo.removeClass(dojo.query('.'+target)[0], 'esri-hidden');
    } else {
      console.log('no target');
      dojo.removeClass(tabbedContent[0], 'esri-hidden');
    }

    
    for(var j = 0; j < tabTriggers.length; j++) {
      dojo.removeClass(tabTriggers[j], 'esri-active');
    }
    if(currTab) {
      dojo.addClass(currTab, 'esri-active');
    } else {
      dojo.addClass(tabTriggers[0], 'esri-active');
    }
}

    var tableDataStrBand = "<table><tr><th>Oct. 5</th><td>7:30pm - Blues with the Mid-Atlantic Symphony Orchestra</td></tr><tr><th>Oct. 9</th><td>6:00pm - Blues | WWII Memorial Evening Concert Series</td></tr><tr><th>Oct. 10</th><td>10:30am - The U.S. Army's Spirit of America</td></tr><tr><th>Oct. 11</th><td>10:30am - The U.S. Army's Spirit of America</td></tr><tr><th>Oct. 11</th><td>7:30pm - The U.S. Army's Spirit of America</td></tr><tr><th>Oct. 12</th><td>2:00pm - The U.S. Army's Spirit of America</td></tr><tr><th>Oct. 12</th><td>7:30pm - The U.S. Army's Spirit of America</td></tr><tr><th>Oct. 17</th><td>5:00pm - Blues | Music of Herbie Nichols</td></tr><tr><th>Oct. 18</th><td>10:30am - The U.S. Army's Spirit of America</td></tr><tr><th>Oct. 18</th><td>7:30pm - The U.S. Army Chorus Baritones in Recital</td></tr><tr><th>Oct. 19</th><td>2:00pm - The U.S. Army's Spirit of America</td></tr><tr><th>Oct. 19</th><td>7:30pm - The U.S. Army's Spirit of America</td></tr><tr><th>Oct. 19</th><td>7:30pm - The U.S. Army Chorus Baritones in Recital</td></tr></table>";
    var usCapitol = 'After adopting the Articles of Confederation, the Congress of the Confederation was formed and convened in Philadelphia from March 1781 until June 1783, when a mob of angry soldiers converged upon Independence Hall, demanding payment for their service during the American Revolutionary War. Congress requested that John Dickinson, the Governor of Pennsylvania, call up the militia to defend Congress from attacks by the protesters. In what became known as the Pennsylvania Mutiny of 1783, Dickinson sympathized with the protesters and refused to remove them from Philadelphia.<br/><br/>As a result, Congress was forced to flee to Princeton, New Jersey, on June 21, 1783, and met in Annapolis, Maryland and Trenton, New Jersey before ending up in New York City.';
/*
    var richTextStr = '<figure><img src="//upload.wikimedia.org/wikipedia/commons/thumb/4/4f/US_Capitol_west_side.JPG/240px-US_Capitol_west_side.JPG" /><figcaption>The west front of the United States Capitol in 2013, before dome restoration scaffolding was erected</figcaption></figure><p>The <b>United States Capitol</b>, often called <b>Capitol Hill</b>, is the seat of the <a title="United States Congress">United States Congress</a>, the <a title="Legislative branch of the United States federal government" class="mw-redirect">legislative branch</a> of the <a title="Federal government of the United States">U.S. federal government</a>. It sits atop <a title="Capitol Hill">Capitol Hill</a>, at the eastern end of the <a title="National Mall">National Mall</a> in <a title="Washington, D.C.">Washington, D.C.</a>. Though not at the geographic center of the <a title="Geography of Washington, D.C.">Federal District</a>, the Capitol forms the origin point for the District\'s street-numbering system and <a title="Quadrants of Washington, D.C.">the District\'s four quadrants</a>.</p><p>The original building was completed in the year 1800 and was subsequently expanded, particularly with the addition of the massive <a href="/wiki/United_States_Capitol_dome" title="United States Capitol dome">dome</a>. Like the principal buildings of the executive and judicial branches, the Capitol is built in a distinctive <a title="Neoclassical architecture">neoclassical style</a> and has a white exterior. Both its east and west elevations are formally referred to as <i>fronts</i>, though only the east front was intended for the reception of visitors and dignitaries.</p><p>In 2014, scaffolding was erected around the dome for a restoration project scheduled to be completed by early 2017.</p>';*/

    var lawnStr = '<figure><img src="http://www.aoc.gov/sites/default/files/styles/artwork-node/public/6427409965_2c317e1225_o.jpg?itok=0I-oCZH8"></figure><p>Originally a wooded wilderness, the U.S. Capitol Grounds now provide a park-like setting for the nation\'s <a>Capitol Building</a>, offering a picturesque counterpoint to the building\'s formal architecture. The grounds immediately surrounding the U.S. Capitol are bordered by a stone wall and cover an area of 58.8 acres. It’s &nbsp;boundaries are Independence Avenue on the south, Constitution Avenue on the north, First Street NE/SE on the east, and First Street NW/SW on the west.</p><p>Over 100 varieties of trees and bushes are planted around the U.S. Capitol, and thousands of flowers are used in seasonal displays. In contrast to the building\'s straight, neoclassical lines, most of the walkways in the grounds are curved. Benches along the paths offer pleasant spots for visitors to appreciate the building, its landscape, and the surrounding areas, most notably the National Mall to the west.</p><p>The grounds were designed by <a href="/capitol-grounds/frederick-law-olmsted" title="Frederick Law Olmsted">Frederick Law Olmsted</a> (1822-1903), who planned the expansion and landscaping of the area that was performed from 1874 to 1892. Olmsted, who also designed New York\'s Central Park, is considered the greatest American landscape architect of his day. He was a pioneer in the development of public parks in America, and many of his designs were influenced by his studies of European parks, gardens and estates. In describing his plan for the Capitol Grounds, Olmsted noted that "The ground is in design part of the U.S. Capitol, but in all respects subsidiary to the central structure." Therefore, he was careful not to group trees or other landscape features in any way that would distract the viewer from the U.S. Capitol Building. The use of sculpture and other ornamentation has also been kept to a minimum.</p><p>Many of the trees on the Capitol Grounds have historic or memorial associations.&nbsp;A number&nbsp;commemorate members of Congress and other notable citizens, national organizations and special events. In addition, more than 30 states have made symbolic gifts of their state trees to the Capitol Grounds. Many of the trees on the grounds bear plaques that identify their species and their historic significance. The eastern part of the grounds contains the greatest number of historic and commemorative trees.</p><p>At the East Capitol Street entrance to the Capitol Plaza are two large rectangular stone fountains. The bottom levels now contain plantings, but at times in the past they have been used to catch the spillover from the fountains. At other times, both levels have held plantings. Six massive red granite lamp piers topped with light fixtures in wrought-iron cages, and 16 smaller bronze light fixtures, line the paved plaza. Seats are placed at intervals along the sidewalks. Three sets of benches are enclosed with wrought-iron railings and grilles; the roofed bench was originally a shelter for streetcar passengers.</p>';

  </script>
</head>

<body>
  <div id="sceneDiv"></div>
  <!--<script src="https://code.jquery.com/jquery-2.1.4.min.js" type="text/javascript"></script>-->
</body>

</html>