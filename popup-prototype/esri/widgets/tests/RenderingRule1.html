<!DOCTYPE HTML>
<html>
<head>
	<meta http-equiv="PRAGMA" content="NO-CACHE">
	<meta http-equiv="CACHE-CONTROL" content="NO-CACHE">
	<meta http-equiv="X-UA-Compatible" content="IE=7,IE=9">
	<title>Rendering Rule</title>
  <link rel="stylesheet" type="text/css" href="../../../dijit/themes/claro/claro.css">
  <link rel="stylesheet" type="text/css" href="../../css/main.css">
  <script type="text/javascript">
    var dojoConfig = {
      parseOnLoad: true,
      isDebug: true,
      async: true,
      packages: [
        {
          name: "esri",
          location: "../esri"
        }
      ]
    };
  </script>
  <script type="text/javascript" src="../../../dojo/dojo.js"></script>
  <script type="text/javascript">
    require(["dojo/parser",
      "esri/map",
      "esri/request",
      "esri/layers/ArcGISImageServiceLayer",
      "..//RenderingRule",
      "esri/geometry/Extent",
      "esri/tasks/GeometryService",
      "esri/Graphic",
      "dojo/dom-style",
      "dijit/form/Select",
      "dijit/form/DropDownButton", 
      "dijit/layout/ContentPane",
      "dijit/TooltipDialog",
      "dojo/domReady!"],
      function (parser, Map, esriRequest, ArcGISImageServiceLayer, RenderingRule, 
                Extent, GeometryService, Graphic, domStyle) {

        var map;
        var basemap;
        var myWidget;
        var urlerror=1;
        var seturl="http://imagery.arcgisonline.com/arcgis/rest/services/LandsatGLS/LandsatMaster/ImageServer";
        var loadingImgTag;
        //loading image. id
        function init() {
          dojo.byId("urlValue").value = seturl;
          map = new Map("MapDiv");
          addLayerToMap();
          loadingImgTag = dojo.byId("loadingImg");
          //loading image. id
          dojo.connect(map, "onUpdateStart", function() {
            domStyle.set(loadingImgTag, "display", "block");
            map.disableMapNavigation();
            map.hideZoomSlider();
          });

          dojo.connect(map, "onUpdateEnd", function(error) {
            domStyle.set(loadingImgTag, "display", "none");
            map.enableMapNavigation();
            map.showZoomSlider();
          });
          
          dojo.connect(dojo.byId("addLayerBtn"),"onclick", addLayerToMap);
        }

        function failed(response) { {
            alert("Incorrect URL");
          }
        }

        function addLayerToMap() {
          var url = dojo.byId("urlValue").value;
          map.removeAllLayers();
          var newLayer = new ArcGISImageServiceLayer(url);
          map.addLayer(newLayer);
          newLayer.on("load", function(){
            if (myWidget == null) {
              myWidget = new RenderingRule({
                layer : newLayer,
                map : map
              }, dojo.byId('nodeid'));
            } else {
              myWidget.set("layer", newLayer);
            }            
            
            myWidget.startup();
            esriRequest({
              url : url,
              content : {
                f : "json"
              },
              callbackParamName : "callback",
              load : dojo.hitch(this, zoomToLayerHandler)
            });            
          });
        }

        function zoomToLayerHandler(response, io) {
          var extent = new Extent(response.extent);
          var geometryService = new GeometryService("http://tasks.arcgisonline.com/ArcGIS/rest/services/Geometry/GeometryServer");
          var graphic = new Graphic(extent);
          var outSR = map.spatialReference;

          geometryService.project([graphic.geometry], outSR, dojo.hitch(this, function(features) {
            map.setExtent(features[0]);
          }));
        }

			  init();
    });
	</script>
</head>
<body class="claro">
  
  	<input id="urlValue" type="text" value="Enter URL" style="width:400px;"/>
  	<button id="addLayerBtn">ADD</button>
  	<div data-dojo-type="dijit/form/DropDownButton" style="width:400px;" id="sfg">
      		<span>Renderer</span>
        <div id="tooltip" data-dojo-type="dijit/TooltipDialog">
     		<div id="nodeid"></div>
    	</div>
  	</div>	
  	<div id="MapDiv" data-dojo-type="dijit/layout/ContentPane" style="height:900px;width:100%;">
    <img id="loadingImg" src="../images/loading.gif" style="position:absolute; right:50%; top:50%; z-index:100;"/>
    </div>
</body>
</html>
