<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <title>Select Features</title>
        <link rel="stylesheet" type="text/css" href="../../../../../dojo/dijit/themes/tundra/tundra.css">
        <script>
            dojoConfig = {
                isDebug: true
            };
        </script>
        <script type="text/javascript" src="../../../../../../index.jsp">
        </script>
        <style type="text/css">
            .messageContainer {
                position: absolute;
                left: 0px;
                right: 0px;
                top: 0px;
                text-align: center;
                z-index: 39;
                height: 0px; /* Without this, map underneath does not receive mouse events */
            }
            
            .dj_ie6 .messageContainer {
                width: 100%;
            }
            
            .messageBar {
                display: inline-block;
                color: #FFFFFF;
                background-color: #444444;
                padding: 5px;
                border: 1px solid #666666;
                border-bottom-left-radius: 5px;
                border-bottom-right-radius: 5px;
                border-top-style: none;
            }
        </style>
        <script type="text/javascript">
            dojo.require("esri.map");
            dojo.require("esri.tasks.identify");
            dojo.require("esri.widgets.Popup");
            dojo.require("doh.runner");
            
            var map;
            function init(){
                var initExtent = new esri.geometry.Extent({
                    "xmin": -9270392.071487641,
                    "ymin": 5247043.693206084,
                    "xmax": -9269914.340060795,
                    "ymax": 5247401.99177622,
                    "spatialReference": {
                        "wkid": 102100
                    }
                });
                
                var popup = new esri.widgets.Popup({
                    fillSymbol: new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID, new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID, new dojo.Color([255, 0, 0]), 2), new dojo.Color([255, 255, 0, 0.25]))
                }, dojo.create("div"));
                
                // Create map with options
                map = new esri.Map("mapDiv", {
                    extent: initExtent,
                    infoWindow: popup
                });
                
                //dojo.place(popup.domNode, map.root);
                
                dojo.connect(map, "onLayerAdd", runTests);
                
                // Add layers
                var basemap = new esri.layers.ArcGISTiledMapServiceLayer("http://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer");
                map.addLayer(basemap);
                
                var landBaseLayer = new esri.layers.ArcGISDynamicMapServiceLayer("http://sampleserver3.arcgisonline.com/ArcGIS/rest/services/BloomfieldHillsMichigan/Parcels/MapServer", {
                    opacity: .20
                });
                map.addLayer(landBaseLayer);
                
                
                
            }
            
            function runTests(){
            
                doh.registerGroup("createmap.itemid.popup.test", [{
                    name: "testpopupwindow",
                    timeout: 3000,
                    runTest: function(t){
                        console.log("runtest");
                        
                        var identifyTask = new esri.tasks.IdentifyTask("http://sampleserver3.arcgisonline.com/ArcGIS/rest/services/BloomfieldHillsMichigan/Parcels/MapServer");
                        var identifyParams = new esri.tasks.IdentifyParameters();
                        identifyParams.tolerance = 3;
                        identifyParams.returnGeometry = true;
                        identifyParams.layerIds = [0, 2];
                        identifyParams.layerOption = esri.tasks.IdentifyParameters.LAYER_OPTION_ALL;
                        identifyParams.width = map.width;
                        identifyParams.height = map.height;
                        identifyParams.geometry = new esri.geometry.Point({
                            "x": -9270128.124874314,
                            "y": 5247478.428804459,
                            "spatialReference": {
                                "wkid": 102100
                            }
                        });
                        
                        identifyParams.mapExtent = map.extent;
                        identifyParams.spatialReference = new esri.SpatialReference({
                            wkid: 102100
                        });
                        
                        
                        var d = new doh.Deferred();
                        
                        var deferred = identifyTask.execute(identifyParams);
                        
                        deferred.addCallback(function(response){
                            // response is an array of identify result objects
                            console.log(response);
                            
                            var template = new esri.InfoTemplate("this is test", "${*}");
                            
                            
                            return dojo.map(response, function(result){
                                var feature = result.feature;
                                feature.attributes.layerName = result.layerName;
                                feature.setInfoTemplate(template);
                                return feature;
                            });
                            
                            
                        });
						console.log("deferred");
						console.log(deferred);
						map.infoWindow.setFeatures([ deferred ]);
						console.log("infoWindow");
						console.log(map.infoWindow._title);
						
						d.callback(true);
                        
                        
                        
                        return d;
                    }
                    
                }]);
                doh.run();
            }
            
            dojo.addOnLoad(init);
        </script>
    </head>
    <body class="claro" style="font-size: 0.8em; font-family: Verdana,Arial,Helvetica,sans-serif;">
        <div id="mapDiv" style="position: relative; width:800px; height:600px; border:1px solid #000;">
            <!-- Info Panel -->
            <div class="messageContainer">
                <span class="messageBar">Building and tax parcel information</span>
            </div>
        </div>
    </body>
</html>
