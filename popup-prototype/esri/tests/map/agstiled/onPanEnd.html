<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">

<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>onPanEnd</title>

    <link rel="stylesheet" type="text/css" href="../../../../dojo/dijit/themes/tundra/tundra.css">
    <script>
        dojoConfig = {
            isDebug: true
        };
    </script>
    <script type="text/javascript" src="../../../../../index.jsp">
    </script>

    <script type="text/javascript">
      dojo.require("esri.map");
      dojo.require("doh.runner");

      var map;

      function init() {
        map = new esri.Map("mapDiv");
        dojo.connect(map, "onLoad", runTests);
        map.addLayer(new esri.layers.ArcGISTiledMapServiceLayer("http://sampleserver1.arcgisonline.com/ArcGIS/rest/services/PublicSafety/PublicSafetyBasemap/MapServer"));
      }
      
      function runTests() {
        doh.registerGroup("map.agstiled.onPanEnd", [
          //Map.pan
          {
            name: "panUpperLeft",
            timeout: 3000,
            runTest: function(t) {
              var onPanEndHandler;
              var d = new doh.Deferred();

              function assert(extent, delta) {
                dojo.disconnect(onPanEndHandler);
                t.assertTrue(extent instanceof esri.geometry.Extent);
                t.assertTrue(delta instanceof esri.geometry.Point);
                t.assertEqual({"xmin":-86.55595175165425,"ymin":38.29335603263823,"xmax":-85.85282673853845,"ymax":38.64491853919613,"spatialReference":{"wkid":4326}}, extent.toJson());
                t.assertEqual({"x":768,"y":384}, delta.toJson());
                d.callback(true);
              }

              setTimeout(function() {
                onPanEndHandler = dojo.connect(map, "onPanEnd", assert);
                map.panUpperLeft();
              }, 1000);
              return d;
            }
          },
          
          {
            name: "panLowerRight",
            timeout: 3000,
            runTest: function(t) {
              var onPanEndHandler;
              var d = new doh.Deferred();

              function assert(extent, delta) {
                dojo.disconnect(onPanEndHandler);
                t.assertTrue(extent instanceof esri.geometry.Extent);
                t.assertTrue(delta instanceof esri.geometry.Point);
                t.assertEqual({"xmin":-85.50126423198054,"ymin":37.766012272801376,"xmax":-84.79813921886475,"ymax":38.11757477935927,"spatialReference":{"wkid":4326}}, extent.toJson());
                t.assertEqual({"x":-768,"y":-384}, delta.toJson());
                d.callback(true);
              }

              setTimeout(function() {
                onPanEndHandler = dojo.connect(map, "onPanEnd", assert);
                map.panLowerRight();
              }, 1000);
              return d;
            }
          },
          
          {
            name: "panUp",
            timeout: 3000,
            runTest: function(t) {
              var onPanEndHandler;
              var d = new doh.Deferred();

              function assert(extent, delta) {
                dojo.disconnect(onPanEndHandler);
                t.assertTrue(extent instanceof esri.geometry.Extent);
                t.assertTrue(delta instanceof esri.geometry.Point);
                t.assertEqual({"xmin":-86.0286079918174,"ymin":38.29335603263823,"xmax":-85.3254829787016,"ymax":38.64491853919613,"spatialReference":{"wkid":4326}}, extent.toJson());
                t.assertEqual({"x":0,"y":384}, delta.toJson());
                d.callback(true);
              }

              setTimeout(function() {
                onPanEndHandler = dojo.connect(map, "onPanEnd", assert);
                map.panUp();
              }, 1000);
              return d;
            }
          },
          
          {
            name: "panDown",
            timeout: 3000,
            runTest: function(t) {
              var onPanEndHandler;
              var d = new doh.Deferred();

              function assert(extent, delta) {
                dojo.disconnect(onPanEndHandler);
                t.assertTrue(extent instanceof esri.geometry.Extent);
                t.assertTrue(delta instanceof esri.geometry.Point);
                t.assertEqual({"xmin":-86.0286079918174,"ymin":37.766012272801376,"xmax":-85.3254829787016,"ymax":38.11757477935927,"spatialReference":{"wkid":4326}}, extent.toJson());
                t.assertEqual({"x":0,"y":-384}, delta.toJson());
                d.callback(true);
              }

              setTimeout(function() {
                onPanEndHandler = dojo.connect(map, "onPanEnd", assert);
                map.panDown();
              }, 1000);
              return d;
            }
          },
          
          {
            name: "panUpperRight",
            timeout: 3000,
            runTest: function(t) {
              var onPanEndHandler;
              var d = new doh.Deferred();

              function assert(extent, delta) {
                dojo.disconnect(onPanEndHandler);
                t.assertTrue(extent instanceof esri.geometry.Extent);
                t.assertTrue(delta instanceof esri.geometry.Point);
                t.assertEqual({"xmin":-85.50126423198054,"ymin":38.29335603263823,"xmax":-84.79813921886475,"ymax":38.64491853919613,"spatialReference":{"wkid":4326}}, extent.toJson());
                t.assertEqual({"x":-768,"y":384}, delta.toJson());
                d.callback(true);
              }

              setTimeout(function() {
                onPanEndHandler = dojo.connect(map, "onPanEnd", assert);
                map.panUpperRight();
              }, 1000);
              return d;
            }
          },
          
          {
            name: "panLowerLeft",
            timeout: 3000,
            runTest: function(t) {
              var onPanEndHandler;
              var d = new doh.Deferred();

              function assert(extent, delta) {
                dojo.disconnect(onPanEndHandler);
                t.assertTrue(extent instanceof esri.geometry.Extent);
                t.assertTrue(delta instanceof esri.geometry.Point);
                t.assertEqual({"xmin":-86.55595175165425,"ymin":37.766012272801376,"xmax":-85.85282673853845,"ymax":38.11757477935927,"spatialReference":{"wkid":4326}}, extent.toJson());
                t.assertEqual({"x":768,"y":-384}, delta.toJson());
                d.callback(true);
              }

              setTimeout(function() {
                onPanEndHandler = dojo.connect(map, "onPanEnd", assert);
                map.panLowerLeft();
              }, 1000);
              return d;
            }
          },
          
          {
            name: "panRight",
            timeout: 3000,
            runTest: function(t) {
              var onPanEndHandler;
              var d = new doh.Deferred();

              function assert(extent, delta) {
                dojo.disconnect(onPanEndHandler);
                t.assertTrue(extent instanceof esri.geometry.Extent);
                t.assertTrue(delta instanceof esri.geometry.Point);
                t.assertEqual({"xmin":-85.50126423198054,"ymin":38.0296841527198,"xmax":-84.79813921886475,"ymax":38.3812466592777,"spatialReference":{"wkid":4326}}, extent.toJson());
                t.assertEqual({"x":-768,"y":0}, delta.toJson());
                d.callback(true);
              }

              setTimeout(function() {
                onPanEndHandler = dojo.connect(map, "onPanEnd", assert);
                map.panRight();
              }, 1000);
              return d;
            }
          },
          
          {
            name: "panLeft",
            timeout: 3000,
            runTest: function(t) {
              var onPanEndHandler;
              var d = new doh.Deferred();

              function assert(extent, delta) {
                dojo.disconnect(onPanEndHandler);
                t.assertTrue(extent instanceof esri.geometry.Extent);
                t.assertTrue(delta instanceof esri.geometry.Point);
                t.assertEqual({"xmin":-86.55595175165425,"ymin":38.0296841527198,"xmax":-85.85282673853845,"ymax":38.3812466592777,"spatialReference":{"wkid":4326}}, extent.toJson());
                t.assertEqual({"x":768,"y":0}, delta.toJson());
                d.callback(true);
              }

              setTimeout(function() {
                onPanEndHandler = dojo.connect(map, "onPanEnd", assert);
                map.panLeft();
              }, 1000);
              return d;
            }
          },
          
          //Map.centerAt
          {
            name: "centerAt",
            timeout: 3000,
            runTest: function(t) {
              var onPanEndHandler;
              var d = new doh.Deferred();

              function assert(extent, delta) {
                dojo.disconnect(onPanEndHandler);
                t.assertTrue(extent instanceof esri.geometry.Extent);
                t.assertTrue(delta instanceof esri.geometry.Point);
                t.assertEqual({"xmin":-123.0374282622423,"ymin":45.11792586208928,"xmax":-122.3343032491265,"ymax":45.46948836864718,"spatialReference":{"wkid":4326}}, extent.toJson());
                t.assertEqual({"x":53898,"y":10323}, delta.toJson());
                d.callback(true);
              }

              setTimeout(function() {
                onPanEndHandler = dojo.connect(map, "onPanEnd", assert);
                map.centerAt(new esri.geometry.Point({x:-122.68553273223391,y:45.29346761037123,spatialReference:{wkid:4326}}));
              }, 1000);
              return d;
            }
          },
          
          //Map.setExtent
          {
            name: "setExtentPan",
            timeout: 3000,
            runTest: function(t) {
              var onPanEndHandler;
              var d = new doh.Deferred();

              function assert(extent, delta) {
                dojo.disconnect(onPanEndHandler);
                t.assertTrue(extent instanceof esri.geometry.Extent);
                t.assertTrue(delta instanceof esri.geometry.Point);
                
                 t.assertEqual({"xmin":-123.03742826224232,"ymin":45.117925862089294,"xmax":-122.33430324912652,"ymax":45.46948836864719,"spatialReference":{"wkid":4326}}, extent.toJson());
                t.assertEqual({x:0,y:0}, startPoint.toJson());
                d.callback(true);
              }

              setTimeout(function() {
                onPanEndHandler = dojo.connect(map, "onPanEnd", assert);
                map.setExtent(new esri.geometry.Extent({"xmin":-85.50126423198057,"ymin":38.02968415271981,"xmax":-84.79813921886478,"ymax":38.38124665927771,"spatialReference":{"wkid":4326}}));
              }, 1000);
              return d;
            }
          }
        ]);
        doh.run();
      }
      
      dojo.addOnLoad(init);
    </script>

  </head>
  <body class="tundra">
    <div id="mapDiv" style="width:1024px; height:512px; border:1px solid #000;"></div>
  </body>
</html>
