<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <title>Geoenrichment API</title>
    
    <style>
        html, body, .app, .map
        {
            width: 100%;
            height: 100%;
            overflow: hidden;
            margin: 0;
        }

        #infographicContainer
        {
            position: absolute;
            top: 5px;
            right: 5px;
        }

        .ProgressBar
        {
            position: fixed;
            left: 10px;
            bottom: 10px;
            width: 100px;
            display: none;
        }

        .InfographicRoot
        {
            width: 210px;
            height: 215px;
        }
    </style>
</head>
<body class="claro">
    <script src="inject.js"></script>
    <script src="config.js"></script>

    <script>
        require([
            "dijit/ProgressBar",
            "esri/map",
            "esri/layers/FeatureLayer",
            "esri/renderers/SimpleRenderer",
            "esri/symbols/SimpleFillSymbol",
            "esri/Graphic",
            "esri/widgets/geoenrichment/Infographic",
            "esri/widgets/geoenrichment/theme",
            "esri/tasks/geoenrichment/GeometryStudyArea",
            "esri/IdentityManager",
            "dojo/domReady!"
        ], function (
            ProgressBar,
            Map,
            FeatureLayer,
            SimpleRenderer,
            SimpleFillSymbol,
            Graphic,
            Infographic,
            theme,
            GeometryStudyArea,
            id
            ) {

            var map = new Map("map", {
                basemap: "hybrid",
                center: [-98.215, 38.382],
                zoom: 7,
                sliderStyle: "small"
            });
            var layer = new FeatureLayer("http://sampleserver1.arcgisonline.com/ArcGIS/rest/services/Demographics/ESRI_Census_USA/MapServer/3");
            layer.setRenderer(new SimpleRenderer(new SimpleFillSymbol()));
            map.addLayer(layer);

            var progressBar = new ProgressBar({
                "class": "ProgressBar",
                indeterminate: true
            });
            progressBar.placeAt(document.body);

            theme.set(document.body, "light"); //set light theme for all infographics in the document

            var graphic;
            var infographics;
            map.on("click", function (e) {
                if (!e.graphic) {
                    return;
                }
                var geom = e.graphic.geometry;
                if (!graphic) {
                    var symbol = new SimpleFillSymbol();
                    symbol.outline.width = 4;
                    graphic = new Graphic(geom, symbol);
                    map.graphics.add(graphic);
                } else {
                    graphic.setGeometry(geom);
                }

                if (!infographics) {
                    infographics = [];

                    infographics.push(createInfographic("AgePyramid", ["Age.*"], null, "info1"));
                    infographics.push(createInfographic("Tapestry", ["Tapestry.*"], "Tapestry Segments", "info2"));
                    infographics.push(createInfographic("RelatedVariables", ["HouseholdsByIncome.*"], null, "info3"));
                    infographics.push(createInfographic("OneVar", ["KeyGlobalFacts.AVGHHSZ"], "Household Size", "info4"));
                }

                for (var i = 0; i < infographics.length; i++) {
                    infographics[i].set("studyArea", new GeometryStudyArea({ geometry: geom }));
                }
            });

            var busy = 0;
            function addBusy() {
                if (busy == 0) {
                    progressBar.domNode.style.display = "block";
                }
                busy++;
            }
            function removeBusy() {
                if (busy > 0) {
                    busy--;
                    if (busy == 0) {
                        progressBar.domNode.style.display = "none";
                    }
                }
            }

            function createInfographic(type, variables, title, parent) {
                var infographic = new Infographic({
                    "class": "InfographicRoot",
                    type: type,
                    variables: variables,
                    title: title,
                    expanded: false,
                    autoWidth: false,
                    autoHeight: false,
                    onDataRequest: addBusy,
                    onDataLoad: removeBusy
                }, parent);
                infographic.startup();
                infographics.push(infographic);
                return infographic;
            }
        });
    </script>
    <div id="map"></div>
    <table id="infographicContainer">
        <tr>
            <td>
                <div id="info1"></div>
            </td>
            <td>
                <div id="info2"></div>
            </td>
        </tr>
        <tr>
            <td>
                <div id="info3"></div>
            </td>
            <td>
                <div id="info4"></div>
            </td>
        </tr>
    </table>
</body>
</html>
