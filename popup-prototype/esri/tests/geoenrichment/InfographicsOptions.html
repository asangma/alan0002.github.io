<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <title>Geoenrichment API</title>

    <style>
        html, body, .app, .map
        {
            width: 100%;
            height: 100%;
            overflow: hidden;
            margin: 0;
        }

        #infographics
        {
            position: absolute;
            top: 20px;
            right: 20px;
        }
    </style>
</head>
<body class="claro">
    <script src="inject.js"></script>
    <script src="config.js"></script>

    <script>
        require([
            "dojo/_base/Color",
            "esri/map",
            "esri/geometry/Extent",
            "esri/symbols/SimpleMarkerSymbol",
            "esri/symbols/SimpleFillSymbol",
            "esri/symbols/SimpleLineSymbol",
            "esri/Graphic",
            "esri/widgets/geoenrichment/InfographicsCarousel",
            "esri/widgets/geoenrichment/InfographicsOptions",
            "esri/tasks/geoenrichment/DriveBuffer",
            "esri/tasks/geoenrichment/GeometryStudyArea",
            "esri/IdentityManager",
            "dojo/domReady!"
        ], function (
            Color,
            Map,
            Extent,
            SimpleMarkerSymbol,
            SimpleFillSymbol,
            SimpleLineSymbol,
            Graphic,
            InfographicsCarousel,
            InfographicsOptions,
            DriveBuffer,
            GeometryStudyArea,
            id
            ) {

            var map = new Map("map", {
                basemap: "hybrid",
                extent: new Extent({ xmin: -122.6284, xmax: -122.186201, ymin: 37.65675, ymax: 37.985552 }),
                sliderStyle: "small"
            });

            prepareOptions();

            function prepareOptions() {

                var options = new InfographicsOptions();
                options.studyAreaOptions = new DriveBuffer({ radius: 15 }); // 15-minutes drive time
                options.theme = "light";
                options.getItems("US").then(function (items) {

                    //
                    //Hide all the default items
                    //
                    for (var i = 0; i < items.length; i++) {
                        items[i].isVisible = false;
                    }

                    //
                    //Add a couple of new ones
                    //
                    var item;

                    item = new InfographicsOptions.Item("OneVar", ["Wealth.PCI_CY"]);
                    item.title = "Per Capita Income";
                    items.push(item);

                    item = new InfographicsOptions.Item("OneVar", ["LandCover.NLCDfrstPt"]);
                    item.datasetID = "LANDSCAPE";
                    item.title = "Forest (NLCD)";
                    items.push(item);

                    handleMapClicks(options);
                });
            }

            function handleMapClicks(options) {

                var inGraphic;
                var outGrphic;
                var infographics;
                var outline = new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new Color([0, 255, 255]), 2);

                map.on("click", function (e) {
                    var point = e.mapPoint;
                    if (!inGraphic) {
                        inGraphic = new Graphic(point, new SimpleMarkerSymbol(SimpleMarkerSymbol.STYLE_CROSS, 15, outline));
                        map.graphics.add(inGraphic);
                    } else {
                        inGraphic.setGeometry(point);
                    }

                    if (!infographics) {
                        infographics = new InfographicsCarousel({
                            returnGeometry: true,
                            options: options
                        }, "infographics");
                        infographics.on("data-ready", function (e) {
                            var ring = e.provider.getGeometry();
                            if (!outGrphic) {
                                outGrphic = new Graphic(ring, new SimpleFillSymbol(SimpleFillSymbol.STYLE_SOLID, outline, new Color([0, 255, 255, 0.25])));
                                map.graphics.add(outGrphic);
                            }
                            else {
                                outGrphic.setGeometry(ring);
                            }
                        });
                        infographics.startup();
                    }
                    infographics.set("studyArea", new GeometryStudyArea({ geometry: point }));
                });
            }
        });

    </script>
    <div id="map"></div>
    <div id="infographics"></div>
</body>
</html>
