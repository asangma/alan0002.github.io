<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <title>Geoenrichment API</title>
    
    <style>
        html, body, .app, .map
        {
            width: 100%;
            height: 100%;
            overflow: hidden;
            margin: 0;
        }

        td
        {
            padding-top: 10px;
        }

        #infoContainer
        {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: #F7F7F7;
            width: 300px;
            height: 400px;
            padding: 10px;
        }

        #title
        {
            text-align: center;
            width: 290px;
        }

        #result
        {
            width: 290px;
            height: 220px;
            max-height: 240px;
            overflow: auto;
            border: 1px solid #eaeaea;
        }

        .ProgressBar
        {
            position: fixed;
            left: 10px;
            bottom: 10px;
            width: 100px;
            display: none;
        }
    </style>
</head>
<body class="claro">
    <script src="inject.js"></script>
    <script src="config.js"></script>

    <script>
        var task;
        var statesSelect;
        var countiesSelect;
        var ready = true;

        require([
            "dojo/dom-style",
            "dojo/html",
            "dojo/_base/Color",
            "dojox/string/Builder",
            "dijit/form/Select",
            "dijit/ProgressBar",
            "esri/map",
            "esri/symbols/SimpleFillSymbol",
            "esri/symbols/SimpleLineSymbol",
            "esri/Graphic",
            "esri/tasks/geoenrichment/StandardGeographyQueryTask",
            "esri/tasks/geoenrichment/SubGeographyQuery",
            "esri/config",
            "esri/IdentityManager",
            "esri/InfoTemplate",
            "dojo/domReady!"
        ], function (
            domStyle,
            html,
            Color,
            Builder,
            Select,
            ProgressBar,
            Map,
            SimpleFillSymbol,
            SimpleLineSymbol,
            Graphic,
            StandardGeographyQuery,
            SubGeographyQuery,
            config,
            id,
            InfoTemplate
            ) {

            var map = new Map("map", {
                basemap: "streets",
                center: [-122.435, 37.785],
                zoom: 12,
                sliderStyle: "small"
            });

            var progressBar = new ProgressBar({
                "class": "ProgressBar",
                indeterminate: true
            });
            progressBar.placeAt(document.body);

            statesSelect = new Select({ maxHeight: 300 }).placeAt("stepOne");
            countiesSelect = new Select({ maxHeight: 300 }).placeAt("stepTwo");

            task = new StandardGeographyQuery();

            var parameters = {};
            parameters.geographyLayers = "US.WholeUSA";
            parameters.geographyIDs = ["01"];
            parameters.subGeographyLayer = "US.States";
            parameters.returnSubGeographyLayer = true;

            task.onExecuteComplete = bindStates;
            task.execute(parameters);

            progressBar.domNode.style.display = "block";

            function bindStates(response) {
                var states = response.featureSet.features;
                states.sort(sortByName);
                var statesOptions = [{ label: "- select -", value: "_" }];

                for (var i = 0; i < states.length; i++) {
                    var state = states[i];
                    var stateOption = { label: state.attributes["AreaName"], value: state.attributes["AreaID"] };
                    statesOptions.push(stateOption);
                }

                statesSelect.set("options", statesOptions);

                statesSelect.onChange = function (selectedState) {
                    domStyle.set("stepTwoInfo", "display", "none");
                    domStyle.set("stepThreeInfo", "display", "none");

                    if (selectedState && selectedState !== "_") {
                        countiesSelect.set("options", []);

                        var parameters = {};
                        parameters.geographyLayers = "US.States";
                        parameters.geographyIDs = selectedState;
                        parameters.returnSubGeographyLayer = true;
                        parameters.subGeographyLayer = "US.Counties";

                        task.onExecuteComplete = bindCounties;
                        task.execute(parameters);
                        progressBar.domNode.style.display = "block";
                    }
                };

                statesSelect.loadDropDown(function () {
                    domStyle.set("infoContainer", "display", "");
                    domStyle.set("stepOneInfo", "display", "");
                    progressBar.domNode.style.display = "none";
                });
            }

            function bindCounties(response) {
                var counties = response.featureSet.features;
                var countiesOptions = [{ label: "- select -", value: "_" }];

                for (var i = 0; i < counties.length; i++) {
                    var county = counties[i];
                    var countyId = county.attributes["AreaID"];
                    var countyOption = { label: county.attributes["AreaName"], value: countyId };
                    countiesOptions.push(countyOption);
                }

                countiesSelect.set("options", countiesOptions);

                countiesSelect.onChange = function (selectedCounty) {
                    if (!ready)
                        return;

                    domStyle.set("stepThreeInfo", "display", "none");

                    if (selectedCounty && selectedCounty !== "_") {
                        var parameters = {};
                        parameters.geographyLayers = "US.Counties";
                        parameters.geographyIDs = selectedCounty;
                        parameters.returnSubGeographyLayer = true;
                        parameters.subGeographyLayer = "US.ZIP5";
                        parameters.returnGeometry = true;
                        parameters.generalizationLevel = 4;

                        task.onExecuteComplete = bindResult;
                        task.execute(parameters);
                        progressBar.domNode.style.display = "block";
                        ready = false;
                    }
                };

                countiesSelect.loadDropDown(function () {
                    domStyle.set("stepTwoInfo", "display", "");
                    progressBar.domNode.style.display = "none";
                });
            }

            function bindResult(response) {
                var zips = response.featureSet.features;

                var sb = new Builder();
                sb.append("ZIP Codes:<br/>");
                map.infoWindow.hide();
                map.graphics.clear();

                var extent = null;
             
                for (var i = 0; i < zips.length; i++) {
                    var zip = zips[i];
                    sb.append(zip.attributes["AreaID"]);
                    sb.append(" ");
                    sb.append(zip.attributes["AreaName"]);
                    sb.append("<br/>");
                   
                    var geometry = zip.geometry;
                    var symbol = new SimpleFillSymbol();
                    var color = new Color([50, 38, 160, 1]);
                    var line = new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, color, 3);
                    symbol.color = new Color([50, 38, 160, 0.3]);
                    symbol.outline = line;

                    var infoTemplate = new InfoTemplate("${AreaName}", "ZIP Code is ${AreaID}");

                    var graphic = new Graphic(geometry, symbol, zip.attributes, infoTemplate);
                    map.graphics.add(graphic);
                   
                    var zipExtent = geometry.getExtent();

                    if (!extent) {
                        extent = zipExtent;
                    }

                    extent = extent.union(zipExtent);
                }

                html.set("result", sb.toString());
                domStyle.set("stepThreeInfo", "display", "");
                map.setExtent(extent, true);
                progressBar.domNode.style.display = "none";
                ready = true;
            }

            function sortByName(a1, a2) {
                var name1 = a1.attributes["AreaName"].toLowerCase();
                var name2 = a2.attributes["AreaName"].toLowerCase();

                if (name1 < name2)
                    return -1;
                if (name1 > name2)
                    return 1;
                return 0;
            }
        });
    </script>
    <div id="map"></div>
    <div id="infoContainer" style="display: none;">
        <table>
            <tr>
                <td id="title">Standard Geography Task
                </td>
            </tr>
            <tr id="stepOneInfo" style="display: none;">
                <td id="stepOne">1. Select state<br />
                </td>
            </tr>
            <tr id="stepTwoInfo" style="display: none;">
                <td id="stepTwo">2. Select county<br />
                </td>
            </tr>
            <tr id="stepThreeInfo" style="display: none;">
                <td id="stepThree">3. Result
                    <div id="result"></div>
                </td>
            </tr>
        </table>
    </div>
</body>
</html>
