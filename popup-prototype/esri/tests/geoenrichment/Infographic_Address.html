<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <title>Geoenrichment API</title>

    <style>
        html, body, .app, .map
        {
            width: 100%;
            height: 100%;
            overflow: hidden;
            margin: 0;
        }

        #infoContainer
        {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: #F7F7F7;
            width: 440px;
            height: 100px;
            padding: 10px;
        }

        #infographic
        {
            position: absolute;
            top: 130px;
            right: 5px;
        }

        .ProgressBar
        {
            position: fixed;
            left: 10px;
            bottom: 10px;
            width: 100px;
            display: none;
        }
    </style>
</head>
<body class="claro">
    <script src="inject.js"></script>
    <script src="config.js"></script>

    <script>
        var txbAddress;
        var btnApply;

        require([
            "dijit/ProgressBar",
            "esri/map",
            "dijit/form/TextBox",
            "dijit/form/Button",
            "esri/symbols/SimpleFillSymbol",
            "esri/Graphic",
            "esri/widgets/geoenrichment/Infographic",
            "esri/tasks/geoenrichment/GeometryStudyArea",
            "esri/tasks/geoenrichment/AddressStudyArea",
            "esri/geometry/Point",
            "esri/IdentityManager",
            "dojo/domReady!"
        ], function (
            ProgressBar,
            Map,
            TextBox,
            Button,
            SimpleFillSymbol,
            Graphic,
            Infographic,
            GeometryStudyArea,
            AddressStudyArea,
            Point,
            config,
            id
            ) {

            var map = new Map("map", {
                basemap: "streets",
                center: [-122.435, 37.785],
                zoom: 12,
                sliderStyle: "small"
            });

            var progressBar = new ProgressBar({
                "class": "ProgressBar",
                indeterminate: true
            });
            progressBar.placeAt(document.body);

            var graphic;
            var infographic;

            txbAddress = new TextBox({
                maxHeight: 500,
                style: 'width:410px',
                onKeyUp: function (e) { if (e.keyCode == "13") applyAddress(); },
                value: "2806 Laguna St, San Francisco, CA 94123"
            }).placeAt("tdForInput");

            btnApply = new Button({
                label: "Apply",
                onClick: function () {
                    if (txbAddress.get("value").toString() != "") applyAddress();;
                }
            }).placeAt("tdButton");

            function applyAddress() {
                if (!infographic) {
                    infographic = new Infographic({
                        type: "Tapestry",
                        variables: ["Tapestry.*"],
                        title: "Tapestry",
                        returnGeometry: true,
                        onDataRequest: function () {
                            progressBar.domNode.style.display = "block";
                        },
                        onDataLoad: function () {
                            progressBar.domNode.style.display = "none";
                        },
                        onDataReady: function (provider) {
                            var ring = provider.getGeometry();
                            if (!graphic) {
                                graphic = new Graphic(ring, new SimpleFillSymbol());
                                map.graphics.add(graphic);
                            }
                            else {
                                graphic.setGeometry(ring);
                            }

                            var extent = ring.getExtent();
                            map.centerAt(new Point((extent.xmin + extent.xmax) / 2, (extent.ymin + extent.ymax) / 2, extent.spatialReference));
                        }
                    }, "infographic");
                    infographic.startup();
                }
                infographic.set("countryID", "US");
                infographic.set("studyArea", new AddressStudyArea({ "address": { "text": txbAddress.get("value") } }));
            };


        });
    </script>
    <div id="map"></div>
    <div id="infographic"></div>
    <div id="infoContainer">
        <table>
            <tr>
                <td id="title">Input address
                </td>
            </tr>
            <tr>
                <td id="tdForInput">
                    <!--input type="text"
                        style="width:300px" 
                        
                        value="2806 Laguna St, San Francisco, CA 94123"
                        data-dojo-type="dijit/form/TextBox"
                        data-dojo-props="trim:true, propercase:true" 
                        id="tbxAddress" 
                        data-dojo-attach-point="tbxAddress"
                        data-dojo-attach-event="onKeyUp: applyAddress"
                        /-->
                </td>
            </tr>
            <tr>
                <td id="tdButton" style="text-align: right">
                    <!--button  data-dojo-attach-point="_btnApply" data-dojo-attach-event="click: applyAddress" disabled>Apply</button-->
                </td>
            </tr>
            <tr>
                <td id="tdTest"></td>
            </tr>
        </table>
    </div>

</body>
</html>
