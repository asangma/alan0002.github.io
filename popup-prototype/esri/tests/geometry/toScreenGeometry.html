<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">

<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>esri.geometry.toScreenGeometry</title>

    <link rel="stylesheet" type="text/css" href="../../../dojo/dijit/themes/tundra/tundra.css">
    <script type="text/javascript" src="../../../dojo/dojo/dojo.js" djConfig="isDebug:true"></script>
    <script type="text/javascript" src="../../esri.js"></script>
    <script type="text/javascript" src="../../jsapi.js"></script>
    
    <script type="text/javascript">
      dojo.require("esri.map");
      dojo.require("esri.tasks.query");
      dojo.require("esri.toolbars.draw");
      dojo.require("doh.runner");
      
      var map, tb;
      
      function init() {
        map = new esri.Map("mapDiv", { 
          // extent: new esri.geometry.Extent({"xmin":7639960.121941003,"ymin":645294.8632096769,"xmax":7670287.410539596,"ymax":669037.9378362068,"spatialReference":{"wkid":102726}})
        });
        dojo.connect(map, "onLoad", runTests);
        var layer = new esri.layers.ArcGISDynamicMapServiceLayer("http://servery/ArcGIS/rest/services/Portland/PortlandMap/MapServer");
        layer.setVisibleLayers([2, 3, 4, 6]);
        map.addLayer(layer);
      }
      
      function runTests() {
        doh.registerGroup("geometry.toScreenGeometry", [
          {
            name: "Point",
            timeout: 5000,
            runTest: function(t) {
              var d = new doh.Deferred();
              
              function assert(featureSet) {
                t.assertEqual(1, featureSet.features.length);
                
                var geometry = featureSet.features[0].geometry;
                var screened = esri.geometry.toScreenGeometry(map.extent, map.width, map.height, geometry);
                t.assertTrue(screened instanceof esri.geometry.Point);
                
                var graphic = map.graphics.add(featureSet.features[0].setSymbol(new esri.symbol.SimpleMarkerSymbol().setColor(new dojo.Color([255,0,0]))));
                var shape = graphic.getDojoShape().getShape();

                t.assertEqual(shape.cx, screened.x);
                t.assertEqual(shape.cy, screened.y);
                
                var mapped = esri.geometry.toMapGeometry(map.extent, map.width, map.height, screened);
                t.assertTrue(mapped instanceof esri.geometry.Point);
                
                d.callback(true);
              }
              
              var queryTask = new esri.tasks.QueryTask("http://servery/ArcGIS/rest/services/Portland/PortlandMap/MapServer/3");
              var query = new esri.tasks.Query();
              query.returnGeometry = true;
              query.where = "FID = 50";
              queryTask.execute(query, assert);
              
              return d;
            }
          },
          
          {
            name: "Multipoint",
            timeout: 5000,
            runTest: function(t) {
              var d = new doh.Deferred();

              function assert(featureSet) {
                t.assertEqual(1, featureSet.features.length);
                
                var geometry = featureSet.features[0].geometry;
                var screened = esri.geometry.toScreenGeometry(map.extent, map.width, map.height, geometry);
                t.assertTrue(screened instanceof esri.geometry.Multipoint);
                t.assertEqual(geometry.points.length, screened.points.length);
                
                var graphic = map.graphics.add(featureSet.features[0].setSymbol(new esri.symbol.SimpleMarkerSymbol().setColor(new dojo.Color([255,0,0]))));
                var children = graphic.getDojoShape().children, shape;
                for (var i=0, il=children.length; i<il; i++) {
                  shape = children[i].getShape();
                  t.assertEqual(shape.cx, screened.points[i][0]);
                  t.assertEqual(shape.cy, screened.points[i][1]);
                }
                
                var mapped = esri.geometry.toMapGeometry(map.extent, map.width, map.height, screened);
                t.assertTrue(mapped instanceof esri.geometry.Multipoint);
                t.assertEqual(geometry.points.length, mapped.points.length);
                
                d.callback(true);
              }
              
              var queryTask = new esri.tasks.QueryTask("http://servery/ArcGIS/rest/services/Portland/PortlandMap/MapServer/2");
              var query = new esri.tasks.Query();
              query.returnGeometry = true;
              query.where = "FID = 5";
              queryTask.execute(query, assert);
              
              return d;
            }
          },
          
          {
            name: "Extent",
            timeout: 5000,
            runTest: function(t) {
              var d = new doh.Deferred();

              function assert(featureSet) {
                var geometry = featureSet.getExtent();
                var screened = esri.geometry.toScreenGeometry(map.extent, map.width, map.height, geometry);
                t.assertTrue(screened instanceof esri.geometry.Extent);

                var graphic = map.graphics.add(new esri.Graphic(geometry, new esri.symbol.SimpleFillSymbol().setColor(new dojo.Color([255,255,0,0.25]))));
                var shape = graphic.getDojoShape().getShape();

                t.assertEqual(shape.x, screened.xmin);
                t.assertEqual(shape.y, screened.ymax);
                t.assertEqual(shape.width, screened.getWidth());
                t.assertEqual(shape.height, screened.getHeight());
                
                var mapped = esri.geometry.toMapGeometry(map.extent, map.width, map.height, screened);
                t.assertTrue(mapped instanceof esri.geometry.Extent);
                
                d.callback(true);
              }
              
              var queryTask = new esri.tasks.QueryTask("http://servery/ArcGIS/rest/services/Portland/PortlandMap/MapServer/4");
              var query = new esri.tasks.Query();
              query.returnGeometry = true;
              query.text = "HWY 224";
              queryTask.execute(query, assert);
              
              return d;
            }
          },
          
          {
            name: "Polyline",
            timeout: 5000,
            runTest: function(t) {
              var d = new doh.Deferred();
              
              function assert(featureSet) {
                t.assertEqual(1, featureSet.features.length);
                
                var geometry = featureSet.features[0].geometry;
                var paths = geometry.paths;
                var screened = esri.geometry.toScreenGeometry(map.extent, map.width, map.height, geometry);
                var cPaths = screened.paths;

                t.assertTrue(screened instanceof esri.geometry.Polyline);
                t.assertEqual(geometry.paths.length, screened.paths.length);
                dojo.forEach(geometry.paths, function(gPath, i) {
                  t.assertEqual(gPath.length, screened.paths[i].length);
                });
                
                var graphic = map.graphics.add(featureSet.features[0].setSymbol(new esri.symbol.SimpleLineSymbol().setColor(new dojo.Color([0,255,0])).setWidth(5)));
                // var shape = graphic.getDojoShape();
                // 
                // dojo.forEach(shape.segments, function(segment, pathIndex) {
                //   var args = segment.args;
                //   console.log(args);
                //   console.log(cPaths[pathIndex]);
                // 
                //   for (var i=0, il=args.length; i<il; i++) {
                //     t.assertEqual(args[i], cPaths[pathIndex][i][0]);
                //     t.assertEqual(args[i+1], cPaths[pathIndex][i][1]);
                //     i++;
                //   }
                // });
                
                var mapped = esri.geometry.toMapGeometry(map.extent, map.width, map.height, screened);
                t.assertTrue(mapped instanceof esri.geometry.Polyline);
                t.assertEqual(geometry.paths.length, mapped.paths.length);
                dojo.forEach(geometry.paths, function(gPath, i) {
                  t.assertEqual(gPath.length, mapped.paths[i].length);
                });

                d.callback(true);
              }
              
              var queryTask = new esri.tasks.QueryTask("http://servery/ArcGIS/rest/services/Portland/PortlandMap/MapServer/4");
              var query = new esri.tasks.Query();
              query.returnGeometry = true;
              query.where = "FID = 880";
              queryTask.execute(query, assert);
              
              return d;
            }
          },
          
          {
            name: "Multipart Polyline",
            timeout: 5000,
            runTest: function(t) {
              var d = new doh.Deferred();
              
              function assert(featureSet) {
                var geometry = new esri.geometry.Polyline(featureSet.spatialReference);
                dojo.forEach(featureSet.features, function(feature) {
                  geometry.addPath(feature.geometry.paths[0]);
                });

                var screened = esri.geometry.toScreenGeometry(map.extent, map.width, map.height, geometry);
                
                t.assertTrue(screened instanceof esri.geometry.Polyline);
                t.assertEqual(geometry.paths.length, screened.paths.length);
                dojo.forEach(geometry.paths, function(gPath, i) {
                  t.assertEqual(gPath.length, screened.paths[i].length);
                });
                
                var graphic = map.graphics.add(new esri.Graphic(geometry, new esri.symbol.SimpleLineSymbol().setColor(new dojo.Color([0,0,255])).setWidth(5)));
                
                var mapped = esri.geometry.toMapGeometry(map.extent, map.width, map.height, screened);
                t.assertTrue(mapped instanceof esri.geometry.Polyline);
                t.assertEqual(geometry.paths.length, mapped.paths.length);
                dojo.forEach(geometry.paths, function(gPath, i) {
                  t.assertEqual(gPath.length, mapped.paths[i].length);
                });
                
                d.callback(true);
              }
              
              var queryTask = new esri.tasks.QueryTask("http://servery/ArcGIS/rest/services/Portland/PortlandMap/MapServer/4");
              var query = new esri.tasks.Query();
              query.returnGeometry = true;
              query.where = "FID = 962 OR FID = 963";
              queryTask.execute(query, assert);
              
              return d;
            }
          },
          
          {
            name: "Polygon",
            timeout: 5000,
            runTest: function(t) {
              var d = new doh.Deferred();

              function assert(featureSet) {
                var geometry = featureSet.features[0].geometry;
                var screened = esri.geometry.toScreenGeometry(map.extent, map.width, map.height, geometry);
                var cRings = screened.rings;

                t.assertTrue(screened instanceof esri.geometry.Polygon);
                t.assertEqual(geometry.rings.length, screened.rings.length);
                dojo.forEach(geometry.rings, function(gRing, i) {
                  t.assertEqual(gRing.length, screened.rings[i].length);
                });
                
                var symbol = new esri.symbol.SimpleFillSymbol().setColor(new dojo.Color([255,0,255]));
                symbol.outline.setWidth(0);
                var graphic = map.graphics.add(featureSet.features[0].setSymbol(symbol));
                
                var shape = graphic.getDojoShape();
                
                // dojo.forEach(shape.segments, function(segment, index) {
                //   var args = segment.args;
                //   console.log(args.toString());
                //   console.log(cRings[index].toString());
                // 
                //   for (var i=0, il=args.length; i<il; i++) {
                //     t.assertEqual(args[i], cRings[index][i][0]);
                //     t.assertEqual(args[i+1], cRings[index][i][1]);
                //     i++;
                //   }
                // });
                
                var mapped = esri.geometry.toMapGeometry(map.extent, map.width, map.height, screened);
                t.assertTrue(mapped instanceof esri.geometry.Polygon);
                t.assertEqual(geometry.rings.length, mapped.rings.length);
                dojo.forEach(geometry.rings, function(gRing, i) {
                  t.assertEqual(gRing.length, mapped.rings[i].length);
                });

                d.callback(true);
              }

              var queryTask = new esri.tasks.QueryTask("http://servery/ArcGIS/rest/services/Portland/PortlandMap/MapServer/6");
              var query = new esri.tasks.Query();
              query.returnGeometry = true;
              query.where = "FID = 28";
              queryTask.execute(query, assert);

              return d;
            }
          },

          {
            name: "Multipart Polygon",
            timeout: 5000,
            runTest: function(t) {
              var d = new doh.Deferred();

              function assert(featureSet) {
                var geometry = new esri.geometry.Polygon(featureSet.spatialReference);
                dojo.forEach(featureSet.features, function(feature) {
                  geometry.addRing(feature.geometry.rings[0]);
                });

                var screened = esri.geometry.toScreenGeometry(map.extent, map.width, map.height, geometry);
                
                t.assertTrue(screened instanceof esri.geometry.Polygon);
                t.assertEqual(geometry.rings.length, screened.rings.length);
                dojo.forEach(geometry.rings, function(gRing, i) {
                  t.assertEqual(gRing.length, screened.rings[i].length);
                });
                
                var symbol = new esri.symbol.SimpleFillSymbol().setColor(new dojo.Color([0,255,255]));
                symbol.outline.setWidth(1);
                var graphic = map.graphics.add(new esri.Graphic(geometry, symbol));
                
                var mapped = esri.geometry.toMapGeometry(map.extent, map.width, map.height, screened);
                t.assertTrue(mapped instanceof esri.geometry.Polygon);
                t.assertEqual(geometry.rings.length, mapped.rings.length);
                dojo.forEach(geometry.rings, function(gRing, i) {
                  t.assertEqual(gRing.length, mapped.rings[i].length);
                });

                d.callback(true);
              }

              var queryTask = new esri.tasks.QueryTask("http://servery/ArcGIS/rest/services/Portland/PortlandMap/MapServer/6");
              var query = new esri.tasks.Query();
              query.returnGeometry = true;
              query.where = "FID = 26 OR FID = 27 OR FID = 29";
              queryTask.execute(query, assert);

              return d;
            }
          }
        ],
        
        function() { //setUp
          dojo.extend(esri.tasks.FeatureSet, {
            getExtent: function() {
              var features = this.features;
              var resultUnionExtent;

              if (this.geometryType === 'esriGeometryPoint') {
                var multipoint = new esri.geometry.Multipoint();
                for (var x = 0; x < features.length; x++) {
                  multipoint.addPoint(features[x].geometry);
                }
                resultUnionExtent = multipoint.getExtent();
              }
              else {
                for (var x = 0; x < features.length; x++) {
                  if (x===0) {
                    resultUnionExtent = features[x].geometry.getExtent();
                  }
                  else {
                    resultUnionExtent = resultUnionExtent.union(features[x].geometry.getExtent());
                  }
                }
              }
              return resultUnionExtent;
            }
          });
          
          dojo.extend(esri.geometry.Polyline, {
            join: function(polyline) {
              this.addPath(polyline.paths[0]);
            }
          });
        },
        
        function() { //tearDown
          delete esri.tasks.FeatureSet.prototype.getExtent;
        }
        );
        doh.run();
      }
      
      dojo.addOnLoad(init);
    </script>

  </head>
  <body class="tundra">
    <div id="mapDiv" style="width:1024px; height:512px; border:1px solid #000;"></div>
  </body>
</html>