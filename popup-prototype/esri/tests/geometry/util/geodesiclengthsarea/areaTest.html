<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
    <head>
        <meta name="generator" content="HTML Tidy, see www.w3.org">
        <meta http-equiv="Content-Type" content= "text/html; charset=utf-8">
        <title>Query Features</title>
        <link rel="stylesheet" type="text/css" href= "../../../../../dojo/dijit/themes/tundra/tundra.css">
        <script>
            dojoConfig = {
                isDebug: true
            };
        </script>
        <script type="text/javascript" src="../../../../../../index.jsp">
        </script>
        <script type="text/javascript">
            dojo.require("esri.geometry");
            dojo.require("esri.map");
            dojo.require("doh.runner");
            
            
            var geometryService;
            
            function init(){
            
                var map = new esri.Map("mapDiv");
                dojo.connect(map, "onLoad", runTests);
                var layer = new esri.layers.ArcGISDynamicMapServiceLayer("http://sampleserver1.arcgisonline.com/ArcGIS/rest/services/Specialty/ESRI_StatesCitiesRivers_USA/MapServer");
                map.addLayer(layer);
                
                
            }
            
            function runTests(){
            
            
                doh.registerGroup("geometry.util.geodesiclengthsarea.areaTest", [{
                    name: "geodesicAreas_ACRES",
                    timeout: 3000,
                    runTest: function(t){
                        var d = new doh.Deferred();
                        var polygon = new esri.geometry.Polygon({
                            "rings": [[[-112.29751721152098, 43.814048232788366], [-107.26713403275795, 35.19053421205173], [-98.6436200120213, 39.0232071101569], [-112.29751721152098, 43.93381926085416], [-112.29751721152098, 43.814048232788366]]],
                            "spatialReference": {
                                "wkid": 4326
                            }
                        });
                        
                        var clientAreas = esri.geometry.geodesicAreas([polygon], esri.Units.ACRES);
                        var outSR = new esri.SpatialReference({
                            wkid: 54034
                        });
                        var geodesicPolygon = esri.geometry.geodesicDensify(polygon, 10000);
                        dojo.connect(geometryService, "onProjectComplete", projectedResult);
                        geometryService.project([geodesicPolygon], outSR);
                                          
                        function projectedResult(results){
                            var projectedPolygon = results[0];
                            
                            var areasAndLengthParams = new esri.tasks.AreasAndLengthsParameters();
                            areasAndLengthParams.areaUnit = esri.tasks.GeometryService.UNIT_ACRES;
                            areasAndLengthParams.polygons = [projectedPolygon];
                            geometryService.areasAndLengths(areasAndLengthParams, function(results){
                                var serverArea = results.areas[0];
                                var diff = Math.abs((Math.abs(clientAreas[0]) - Math.abs(serverArea)) / Math.abs(serverArea)) * 100;
                                if (diff < 0.02) {
                                    console.log(diff);
                                    t.assertTrue(true);
                                }
                                d.callback(true);
                            });
                            
                        }
                        
                        return d;
                        
                        
                    }
                    
                    
                }, {
                    name: "geodesicAreas_SQUARE_KILOMETERS",
                    timeout: 3000,
                    runTest: function(t){
                        var d = new doh.Deferred();
                        var polygon = new esri.geometry.Polygon({
                            "rings": [[[-112.29751721152098, 43.814048232788366], [-107.26713403275795, 35.19053421205173], [-98.6436200120213, 39.0232071101569], [-112.29751721152098, 43.93381926085416], [-112.29751721152098, 43.814048232788366]]],
                            "spatialReference": {
                                "wkid": 4326
                            }
                        });
                        
                        var clientAreas = esri.geometry.geodesicAreas([polygon], esri.Units.SQUARE_KILOMETERS);
                        var outSR = new esri.SpatialReference({
                            wkid: 54034
                        });
                        var geodesicPolygon = esri.geometry.geodesicDensify(polygon, 10000);
                        dojo.connect(geometryService, "onProjectComplete", projectedResult);
                        geometryService.project([geodesicPolygon], outSR);
                                           
                        function projectedResult(results){
                            var projectedPolygon = results[0];
                            
                            var areasAndLengthParams = new esri.tasks.AreasAndLengthsParameters();
                            areasAndLengthParams.areaUnit = esri.tasks.GeometryService.UNIT_SQUARE_KILOMETERS;
                            areasAndLengthParams.polygons = [projectedPolygon];
                            geometryService.areasAndLengths(areasAndLengthParams, function(results){
                                var serverArea = results.areas[0];
                                var diff = Math.abs((Math.abs(clientAreas[0]) - Math.abs(serverArea)) / Math.abs(serverArea)) * 100;
                                if (diff < 0.02) {
                                    console.log(diff);
                                    t.assertTrue(true);
                                }
                                d.callback(true);
                            });
                            
                        }
                        
                        return d;
                        
                        
                    }
                    
                    
                }, {
                    name: "geodesicAreas_SQUARE_MILES",
                    timeout: 3000,
                    runTest: function(t){
                        var d = new doh.Deferred();
                        var polygon = new esri.geometry.Polygon({
                            "rings": [[[-112.29751721152098, 43.814048232788366], [-107.26713403275795, 35.19053421205173], [-98.6436200120213, 39.0232071101569], [-112.29751721152098, 43.93381926085416], [-112.29751721152098, 43.814048232788366]]],
                            "spatialReference": {
                                "wkid": 4326
                            }
                        });
                        
                        var clientAreas = esri.geometry.geodesicAreas([polygon], esri.Units.SQUARE_MILES);
                        var outSR = new esri.SpatialReference({
                            wkid: 54034
                        });
                        var geodesicPolygon = esri.geometry.geodesicDensify(polygon, 10000);
                        dojo.connect(geometryService, "onProjectComplete", projectedResult);
                        geometryService.project([geodesicPolygon], outSR);
                                              
                        function projectedResult(results){
                            var projectedPolygon = results[0];
                            
                            var areasAndLengthParams = new esri.tasks.AreasAndLengthsParameters();
                            areasAndLengthParams.areaUnit = esri.tasks.GeometryService.UNIT_SQUARE_MILES;
                            areasAndLengthParams.polygons = [projectedPolygon];
                            geometryService.areasAndLengths(areasAndLengthParams, function(results){
                                var serverArea = results.areas[0];
                                var diff = Math.abs((Math.abs(clientAreas[0]) - Math.abs(serverArea)) / Math.abs(serverArea)) * 100;
                                if (diff < 0.02) {
                                    console.log(diff);
                                    t.assertTrue(true);
                                }
                                d.callback(true);
                            });
                            
                        }
                        
                        return d;
                        
                        
                    }
                    
                    
                }], function()//setUp()
                {
                    esriConfig.request.proxyUrl = "../../../proxy.jsp";
                    esriConfig.request.forceProxy = false;
                    geometryService = new esri.tasks.GeometryService("http://servery/arcgis/rest/services/Geometry/GeometryServer");
                    
                    
                }, function()//tearDown
                {
                    geometryService = null;
                    
                });
                
                
                doh.run();
            }
            
            dojo.addOnLoad(init);
        </script>
    </head>
    <body class="tundra">
        <div id="mapDiv" style="width:900px; height:600px; border:1px solid #000;">
        </div>
    </body>
</html>
