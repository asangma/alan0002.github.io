<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
    <head>
        <meta name="generator" content="HTML Tidy, see www.w3.org">
        <meta http-equiv="Content-Type" content= "text/html; charset=utf-8">
        <title>Query Features</title>
        <link rel="stylesheet" type="text/css" href= "../../../../dojo/dijit/themes/tundra/tundra.css">
        <script>
            dojoConfig = {
                isDebug: true
            };
        </script>
        <script type="text/javascript" src="../../../../../index.jsp">
        </script>
        <script type="text/javascript">
            dojo.require("esri.geometry");
            dojo.require("esri.map");
            dojo.require("doh.runner");
            
            
            var map,layer;
            
            function init(){
            
                map = new esri.Map("mapDiv");
                dojo.connect(map, "onLoad", runTests);
                layer = new esri.layers.ArcGISDynamicMapServiceLayer("http://servery/ArcGIS/rest/services/Portland/PortlandMap/MapServer", {
                    useMapImage: true
                });
                
                map.addLayer(layer);
                
                
            }
            
            function runTests(){
            
            
                doh.registerGroup("geometry.namespace.getScaleTest", [{
                    name: "getScale",
                    timeout: 3000,
                    runTest: function(t){
						var params = new esri.layers.ImageServiceParameters();
						params.height = 600;
                        var scale = esri.geometry.getScale(map);
                        
                        var d = new doh.Deferred();
                                              
                        function assertMapScale(mapImage){
                            dojo.disconnect(handler);
                           	t.assertEqual(scale,mapImage.scale);
                            d.callback(true);
                        }
						
                        var handler = dojo.connect(layer, "onMapImageExport", assertMapScale);
                        layer.exportMapImage(params);
                        return d;
                        
                    }
                }]);
                
                
                doh.run();
            }
            
            dojo.addOnLoad(init);
        </script>
    </head>
    <body class="tundra">
        <div id="mapDiv" style="width:900px; height:600px; border:1px solid #000;">
        </div>
    </body>
</html>
