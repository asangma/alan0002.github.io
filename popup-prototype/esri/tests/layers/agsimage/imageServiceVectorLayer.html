<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <!--The viewport meta tag is used to improve the presentation and behavior of the samples 
      on iOS devices-->
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">
    <title>Image Service Vector Layer with Filter</title>
    <link rel="stylesheet" href="http://js.arcgis.com/3.10/js/dojo/dijit/themes/claro/claro.css">
    <link rel="stylesheet" href="http://js.arcgis.com/3.10/js/esri/css/esri.css">

    <style>
      @import url(http://js.arcgis.com/3.10/js/dojo/dojox/form/resources/RangeSlider.css);
      #info {
        top: 20px;
        color: #444;
        height: auto;
        font-family: arial;
        right: 20px;
        margin: 5px;
        padding: 10px;
        position: absolute;
        width: 115px;
        z-index: 40;
        border: solid 2px #666;
        border-radius: 4px;
        background-color: #fff;
      }
      
      button {
        display: block;
      }
      
      html, body {
        width: 98%;
        height: 98%;
        margin: 0 1%;
        padding: 10px 0 0 0;        
      }
      
      #map
      {
        border: solid 1px #888;
        padding: 0;
      }      

      #status
      {
        background-color: #000;
        color: #FFF;
        border: solid 1px #FFF;
        -moz-border-radius: 5px;
        -webkit-border-radius: 5px;
        border-radius: 5px;
        padding: 3px;
      }

      .shadow
      {
        -moz-border-radius: 6px;
        -webkit-border-radius: 6px;
        border-radius: 6px;
        -moz-box-shadow: 0 6px 3px -3px #bdbdbd;
        -webkit-box-shadow: 0 6px 3px -3px #bdbdbd;
        box-shadow: 0 6px 3px -3px #bdbdbd;
        background-color: #FFF;
        padding: 8px;
      }

      #footer
      {
        height: 80px;
        padding: 10px;
      }      
    </style>

    <script type="text/javascript">
      var dojoConfig = {
        parseOnLoad:true,
        async:true,
        isDebug: true,
        packages: [
            {
              name: "esri",
              location: "../esri" 
            }
        ]
      };
    </script>   
    <script type="text/javascript" src="../../../../dojo/dojo.js"></script>      
    <script>
      var map, tb;
      var imageServiceLayer, symbolTileSize;
      var sliderMin, sliderMax, currentMin, currentMax;
      require([
        "esri/map", 
        
        "esri/toolbars/draw",
        "esri/Graphic",
        "esri/symbols/SimpleMarkerSymbol","esri/symbols/SimpleLineSymbol", "esri/symbols/SimpleFillSymbol",

        "esri/domUtils", "dojo/_base/array", "dijit/registry", "dojo/_base/url", "dojo/has", "dojo/on",
        "esri/Color", "esri/arcgis/utils", "esri/InfoTemplate", "../../../tasks/support/Query",
        
        "esri/layers/ArcGISImageServiceVectorLayer", "esri/renderers/VectorFieldRenderer", "esri/layers/ImageServiceParameters", 
        "esri/layers/RasterFunction", "esri/layers/PixelFilters/VectorFieldPixelFilter", "esri/layers/MosaicRule", "esri/layers/DimensionalDefinition",
        "esri/geometry/Extent", "esri/SpatialReference",
        "dijit/layout/BorderContainer", "dijit/layout/ContentPane",
        "dijit/form/HorizontalSlider", "dojox/form/RangeSlider", "dijit/form/HorizontalRule", "dijit/form/HorizontalRuleLabels",
        "dojo/parser", "dojo/dom", "dojo/on", "dojo/domReady!"
      ], function(
        Map, 
        Draw, Graphic, SimpleMarkerSymbol, SimpleLineSymbol, SimpleFillSymbol,
        domUtils, array, registry, Url, has, on, 
        Color, arcgisUtils, InfoTemplate, Query,
        ArcGISImageServiceVectorLayer, VectorFieldRenderer, ImageServiceParameters, 
        RasterFunction, VectorFieldPixelFilter, MosaicRule, DimensionalDefinition,
        Extent, SpatialReference,
        BorderContainer, ContentPane,
        HorizontalSlider, RangeSlider, HorizontalRule, HorizontalRuleLabels,
        parser, dom, on)
      {
        parser.parse();
        
        function getParameter(name) {
          name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
          var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
              results = regex.exec(location.search);
          return results == null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
        }
        
        var isUrl = getParameter("isUrl") ? getParameter("isUrl") : "http://wju:6080/arcgis/rest/services/demo/uv/ImageServer";
        sliderMin = getParameter("sliderMin") ? parseFloat(getParameter("sliderMin")) : "null";
        sliderMax = getParameter("sliderMax") ? parseFloat(getParameter("sliderMax")) : "null";
        symbolTileSize = getParameter("symbolTileSize") ? Number(getParameter("symbolTileSize")) : 40;
        
        var markerSymbol = new SimpleMarkerSymbol();
        markerSymbol.setPath("M16,4.938c-7.732,0-14,4.701-14,10.5c0,1.981,0.741,3.833,2.016,5.414L2,25.272l5.613-1.44c2.339,1.316,5.237,2.106,8.387,2.106c7.732,0,14-4.701,14-10.5S23.732,4.938,16,4.938zM16.868,21.375h-1.969v-1.889h1.969V21.375zM16.772,18.094h-1.777l-0.176-8.083h2.113L16.772,18.094z");
        markerSymbol.setColor(new Color("#00FFFF"));          
        
        // hook up slider events
        var slider = registry.byId("pixelSlider");
        slider.on("mouseup", setPixelFilter);
        slider.on("change", setPixelFilter);

        var corsEnabledServers, imageServiceAuthority, onceDone;
        imageServiceAuthority = new Url(isUrl).authority;
        corsEnabledServers = esriConfig.request.corsEnabledServers;
        if (!corsEnabledServers.some(function (x) {
          return x === imageServiceAuthority;
        })) {
          corsEnabledServers.push(imageServiceAuthority);
        }
        
        var dataExtent = new Extent(-9588260.828089952, -4914613.913406536, 9588260.828089952, 5299819.050395412, SpatialReference.WebMercator);
        map = new Map("map", {
          basemap: "gray",
          extent: dataExtent
        });
        
        map.on("update-start", function () {
          domUtils.show(dom.byId("status"));
        });
        map.on("update-end", function () {
          domUtils.hide(dom.byId("status"));
        });
        
        var params = new ImageServiceParameters();
        params.pixelType = "F32";
        /*params.mosaicRule = new MosaicRule();
        params.mosaicRule.multidimensionalDefinition = [];
        params.mosaicRule.multidimensionalDefinition.push(new DimensionalDefinition({
          variableName: "Vector-UV",
          dimensionName: "StdTime",
          values: [118281600000]
        })); */
      
        //http://wju:6080/arcgis/rest/services/water_uv/ImageServer
        //http://ec2-54-209-108-232.compute-1.amazonaws.com:6080/arcgis/rest/services/wind/ImageServer       
        imageServiceLayer = new ArcGISImageServiceVectorLayer(isUrl, {
          imageServiceParameters: params,
          rendererStyle: VectorFieldRenderer.STYLE_OCEAN_CURRENT_KN,
          symbolTileSize: symbolTileSize,
          pixelFilter: maskPixels
        });
      
        var infoTemplate = new InfoTemplate();
        infoTemplate.setTitle("Pixel Value: ${Raster.ServicePixelValue}");
        var content = "<b>Product Name</b>: ${ProductName}" +
          "<br><b>ItemPixelValue</b>: ${Raster.ItemPixelValue}" +
          "<br><b>ServicePixelValue</b>: ${Raster.ServicePixelValue}" +
          "<br><b>Standard Time</b>: ${StdTime:DateFormat}";        
        infoTemplate.setContent(content);
        imageServiceLayer.setInfoTemplate(infoTemplate);      

        imageServiceLayer.on("load", function (args) {
          // set min max for the slider
          if (!sliderMax || sliderMax === "null") {
            sliderMin = 0;
            if (imageServiceLayer.bands && imageServiceLayer.bands[0] && imageServiceLayer.bands[0].max) {
              var u = imageServiceLayer.bands[0].max;
              var v = imageServiceLayer.bands[1].max;
              sliderMax = 10;  //Math.sqrt(u * u + v * v);
            }
            else {
              sliderMax = 100;
            }
          }
          if (sliderMax) {
            registry.byId("pixelSlider").minimum = sliderMin;
            registry.byId("pixelSlider").maximum = sliderMax;
            registry.byId("pixelSlider").value = [sliderMin, sliderMax];

            var sliderLabels = new dijit.form.HorizontalRuleLabels(
                 {
                   container: "bottomDecoration",
                   labels: [sliderMin.toFixed(0).toString(), sliderMax.toFixed(0).toString()],
                 }, dojo.create("div", {}, dojo.byId("pixelLabels")));
            
            sliderLabels.startup();
          }
              
          // set resampling
          var resamplingServerFunction = new RasterFunction();
          resamplingServerFunction.functionName = "Resample";
          resamplingServerFunction.functionArguments = {
            ResamplingType: 10,
            InputCellSize: {
              x: imageServiceLayer.pixelSizeX,
              y: imageServiceLayer.pixelSizeY
            }
          };
          
          //imageServiceLayer.setRenderingRule(resamplingServerFunction, true);
        });
        
        map.addLayer(imageServiceLayer);
        map.on("load", initToolbar);
        
        // The pixel filter
        function maskPixels(pixelData) {
          var myUVFilter = new VectorFieldPixelFilter();
          myUVFilter.isDataUV = true;
          pixelData = myUVFilter.computeMagnitudeAndDirection(pixelData);
          if (pixelData == null || pixelData.pixelBlock == null)
            return;

          var pixelBlock = pixelData.pixelBlock;
          var numPixels = pixelBlock.width * pixelBlock.height;
          
          var pixels = pixelBlock.pixels;
          var mask = pixelBlock.mask;
          if (pixels == null || mask == null)
            return;

          if (currentMin == undefined || currentMax == undefined)
            return;
          
          if (mask.length <= 0) {
            console.log("Mask Error");
            mask = new Uint8Array(pixelBlock.height * pixelBlock.width);
            pixelBlock.mask = mask;
          }
          var p1 = p2 = p3 = pixels[0];
          p2 = pixels.length > 1 ? pixels[1] : p1;
          p3 = pixels.length > 2 ? pixels[2] : p1;
          for (var i = 0; i < numPixels; i++) {
            mask[i] = (p1[i] >= Math.floor(currentMin) && p1[i] <= Math.floor(currentMax)) ? 1 : 0;
          }

          return pixelData;
        }

        // Slider move
        function setPixelFilter() {
          var val = registry.byId("pixelSlider").get("value");
          if (val)
            dom.byId("pixelVal").innerHTML = "Currently displaying " + Math.floor(val[0]) + " to " + Math.floor(val[1]);
          else
            dom.byId("pixelVal").innerHTML = "Currently displaying all values in the AOI.";

          currentMin = val[0];
          currentMax = val[1];          
          imageServiceLayer.redraw();
        }
        
        function initToolbar() {
          tb = new Draw(map);
          tb.on("draw-end", queryInfo);

          var pointBtn = dom.byId("info");
          on(dom.byId("info"), "click", function(evt) {
            if ( evt.target.id === "info" ) {
              return;
            }           
            var tool = evt.target.id.toLowerCase();
            map.disableMapNavigation();
            tb.activate(tool);
          });
        }
        
        function queryInfo(evt) {
          tb.deactivate();
          map.enableMapNavigation();
          map.graphics.clear();
          map.graphics.add(new Graphic(evt.geometry, markerSymbol));
          var query = new Query();
          query.geometry = evt.geometry;
          query.outFields = ["*"];
          query.returnGeometry = true;
          imageServiceLayer.queryVisibleRasters(query).then(
            function (results) {
              console.log("results", results);
              array.forEach(results, function (graphic) {
                console.log(graphic);
                map.graphics.add(graphic.setSymbol(new SimpleFillSymbol().setOutline(new SimpleLineSymbol().setColor(new Color([0,255,255]))).setColor(new Color([0,0,0,0]))));
              });
            },
            function (error) {
              console.log("error", error);
            }
          );
        }
        
      });
    </script>
  </head>
  
  <body>
    <div data-dojo-type="dijit/layout/BorderContainer" data-dojo-props="design:'headline', gutters:false"
        style="width: 100%; height: 100%; margin: 0;">
        <div id="info">
          <div>Click on Info to know more...</div>
          <p></p>
          <button id="Point">Info</button>
        </div>        
        <div id="map" class='shadow' data-dojo-type="dijit/layout/ContentPane" data-dojo-props="region:'center'"
            style="height: 100%;">
            <div id="status" style="position: absolute; right: 10px; bottom: 10px; z-index: 99;">
                Loading...
            </div>
        </div>
        <div id="footer" data-dojo-type="dijit/layout/ContentPane" data-dojo-props="region:'bottom'">
            <span style='font-weight: 600;' id='elevSpan'>Filter by Magnitude </span>
            <div id='pixelVal'></div>
            <div id="pixelSlider" data-dojo-type="dojox.form.HorizontalRangeSlider" data-dojo-props="showButtons:'false', intermediateChanges:'false', slideDuration:'0'" minimum:"0" value:"0,255" maximum:"255">
                <div data-dojo-type="dijit/form/HorizontalRule" data-dojo-props='container:"bottomDecoration", count:2, style:{height:"5px"}'></div>
                <div id="pixelLabels"></div>
            </div>
        </div>
    </div>   
  </body>

</html>
