<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">
    <title>Image Service Vector Layer</title>
    <link rel="stylesheet" href="http://js.arcgis.com/3.10/js/dojo/dijit/themes/claro/claro.css">
    <link rel="stylesheet" href="http://js.arcgis.com/3.10/js/esri/css/esri.css">
    <style>
      @import url(http://js.arcgis.com/3.10/js/dojo/dojox/form/resources/RangeSlider.css);
      #info {
        top: 20px;
        color: #444;
        height: auto;
        font-family: arial;
        right: 20px;
        margin: 5px;
        padding: 10px;
        position: absolute;
        width: 115px;
        z-index: 40;
        border: solid 2px #666;
        border-radius: 4px;
        background-color: #fff;
      }
      
      
      html, body {
        width: 98%;
        height: 98%;
        margin: 0 1%;
        padding: 10px 0 0 0;        
      }
      
      #map
      {
        border: solid 1px #888;
        padding: 0;
      }      

      #status
      {
        background-color: #000;
        color: #FFF;
        border: solid 1px #FFF;
        -moz-border-radius: 5px;
        -webkit-border-radius: 5px;
        border-radius: 5px;
        padding: 3px;
      }      

      #footer
      {
        height: 80px;
        padding: 10px;
      }      
    </style>

    <script type="text/javascript">
      var dojoConfig = {
        parseOnLoad:true,
        async:true,
        isDebug: true,
        packages: [
            {
              name: "esri",
              location: "../esri" 
            }
        ]
      };
    </script>   
    <script type="text/javascript" src="../../../../dojo/dojo.js"></script>      
    <script>
      var map, tb;
      var isVectorLayer, symbolTileSize;
      var sliderMin, sliderMax, currentMin, currentMax;
      require([
        "esri/map", 
        "esri/Graphic",
        "esri/symbols/SimpleLineSymbol", "esri/symbols/SimpleFillSymbol",
        "esri/domUtils", "dojo/_base/array", "dijit/registry", "dojo/_base/url", "dojo/has", "dojo/on",
        "esri/Color", "esri/arcgis/utils", "esri/InfoTemplate", "../../../tasks/support/Query",
        "esri/layers/ArcGISImageServiceVectorLayer", "esri/renderers/VectorFieldRenderer", "esri/layers/ImageServiceParameters", 
        "esri/layers/RasterFunction", "esri/layers/PixelFilters/VectorFieldPixelFilter", "esri/layers/MosaicRule", "esri/layers/DimensionalDefinition",
        "esri/geometry/Extent", "esri/SpatialReference",
        "dijit/layout/BorderContainer", "dijit/layout/ContentPane",
        "dojo/parser", "dojo/dom", "dojo/on", "dojo/domReady!"
      ], function(
        Map, 
        Graphic, SimpleLineSymbol, SimpleFillSymbol,
        domUtils, array, registry, Url, has, on, 
        Color, arcgisUtils, InfoTemplate, Query,
        ArcGISImageServiceVectorLayer, VectorFieldRenderer, ImageServiceParameters, 
        RasterFunction, VectorFieldPixelFilter, MosaicRule, DimensionalDefinition,
        Extent, SpatialReference,
        BorderContainer, ContentPane,
        parser, dom, on)
      {
        parser.parse();
                
        var isUrl = "http://wju:6080/arcgis/rest/services/demo/magdir/ImageServer";

        var corsEnabledServers, imageServiceAuthority, onceDone;
        imageServiceAuthority = new Url(isUrl).authority;
        corsEnabledServers = esriConfig.request.corsEnabledServers;
        if (!corsEnabledServers.some(function (x) {
          return x === imageServiceAuthority;
        })) {
          corsEnabledServers.push(imageServiceAuthority);
        }
        
        var dataExtent = new Extent(-9588260.828089952, -4914613.913406536, 9588260.828089952, 5299819.050395412, SpatialReference.WebMercator);
        map = new Map("map", {
          basemap: "gray",
          extent: dataExtent
        });
        
        map.on("update-start", function () {
          domUtils.show(dom.byId("status"));
        });
        map.on("update-end", function () {
          domUtils.hide(dom.byId("status"));
        });
		
        var mr = new MosaicRule();
		mr.method = MosaicRule.METHOD_NORTHWEST;
		mr.operation = MosaicRule.OPERATION_FIRST;
		mr.ascending = true;
        mr.multidimensionalDefinition = [];
        mr.multidimensionalDefinition.push(new DimensionalDefinition({
        variableName: "Vector-MagDir",
        dimensionName: "StdTime",
        values: [1362096000000]
        }));   
		var params = new ImageServiceParameters();
		params.mosaicRule = mr;
		
        isVectorLayer = new ArcGISImageServiceVectorLayer(isUrl, {
          rendererStyle: VectorFieldRenderer.STYLE_CLASSIFIED_ARROW,
          symbolTileSize: 50,
		  imageServiceParameters: params
        });
        
        var sizeInfoVar = {
          type: "sizeInfo",
          minSize: 2,
          maxSize: 40,
          minDataValue: 0.5,
          maxDataValue: 10
        };
        
        var visualVariables = [];
        visualVariables.push(sizeInfoVar);

        var renderer = new VectorFieldRenderer({
          style: VectorFieldRenderer.STYLE_BEAUFORT_KN,
          visualVariables: visualVariables,
          flowRepresentation: VectorFieldRenderer.FLOW_FROM
        });

        isVectorLayer.setRenderer(renderer);       
      
        isVectorLayer.on("load", function (args) {
		//do something here
        });
        
        map.addLayer(isVectorLayer);       
        
      });
    </script>
  </head>
  
  <body>
    <div data-dojo-type="dijit/layout/BorderContainer" data-dojo-props="design:'headline', gutters:false"
        style="width: 100%; height: 100%; margin: 0;">     
        <div id="map" class='shadow' data-dojo-type="dijit/layout/ContentPane" data-dojo-props="region:'center'"
            style="height: 100%;">
            <div id="status" style="position: absolute; right: 10px; bottom: 10px; z-index: 99;">
                Loading...
            </div>
        </div>		
    </div>   
  </body>

</html>
