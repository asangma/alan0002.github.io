<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <title>QueryIds</title>
        <link rel="stylesheet" type="text/css" href="../../../../dojo/dijit/themes/tundra/tundra.css">
        <script>
            dojoConfig = {
                isDebug: true
            };
        </script>
        <script type="text/javascript" src="../../../../../index.jsp">
        </script>

        <script type="text/javascript">
            dojo.require("esri.layers.FeatureLayer");
            
            dojo.require("esri.map");
            
            dojo.require("doh.runner");
            
            var agnLayer,params;
            function init(){
                var startExtent = new esri.geometry.Extent({
                    "xmin": -117.19741474981005,
                    "ymin": 32.6965904538416,
                    "xmax": -117.12872559032095,
                    "ymax": 32.731854065948,
                    "spatialReference": {
                        "wkid": 4269
                    }
                });
                //create map
                var map = new esri.Map("mapDiv", {
                    extent: startExtent
                });
                var basemap = new esri.layers.ArcGISTiledMapServiceLayer("http://server.arcgisonline.com/ArcGIS/rest/services/ESRI_StreetMap_World_2D/MapServer");
                map.addLayer(basemap);
				
				params = new esri.layers.ImageServiceParameters();
                
                agnLayer = new esri.layers.ArcGISDynamicMapServiceLayer("http://webapi20beta.esri.com/ArcGIS/rest/services/Health/h1n1/MapServer");
                var layerTimeOptions = [];
                var layerTimeOption = new esri.layers.LayerTimeOptions();
                layerTimeOption.timeDataCumulative = true;
                layerTimeOption.timeOffset = 10;
                layerTimeOption.timeOffsetUnits = esri.layers.TimeInfo.UNIT_DAYS;
                layerTimeOption.useTime = true;
                layerTimeOptions[0] = layerTimeOption;
				layerTimeOptions[1] = layerTimeOption;
				params.layerTimeOptions = layerTimeOptions;

                
                map.addLayer(agnLayer);
                if (agnLayer.loaded) {
                    runTests(agnLayer);
                }
                else {
                    dojo.connect(agnLayer, "onLoad", runTests);
                }
                
            }
            
            function runTests(agnLayer){
            
                doh.registerGroup("time.agsdynamic.exportMapImage", [{
                    name: "exportMapImage",
                    timeout: 3000,
                    runTest: function(t){
						var d = new doh.Deferred();
                       
                        
                        function assertMapImage(mapImage){
                            console.log(mapImage);
                            var href = mapImage.href;
                            
                            if (href.substr(href.length - 3, 3) === "jpg") {
                                t.assertTrue(true);
                            };
							
                            d.callback(true);
                        }
                        dojo.connect(agnLayer, "onMapImageExport", assertMapImage);
                        agnLayer.exportMapImage(params);
                        return d;
                        
                    }
                    
                }]);
                doh.run();
            }
            
            dojo.addOnLoad(init);
        </script>
    </head>
    <body class="tundra">
        <div id="mapDiv" style="width:900px; height:600px; border:1px solid #000;">
        </div>
    </body>
</html>
