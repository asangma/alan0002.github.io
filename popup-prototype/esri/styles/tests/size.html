<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Size tests</title>

    <script>
      var dojoConfig = {
        isDebug: true,

        packages: [
          { name: "esri", location: "../esri" },
          {
            name: "tests",
            location: location.pathname.replace(/\/[^/]+$/, "")
          }
        ]
      };
    </script>
    <script type="text/javascript" src="../../../dojo/dojo.js"></script>

    <script>
      var size;
      
      require([
        "esri/styles/size",
        
        "dojo/_base/array",
        "dojo/_base/lang",
        
        "tests/size-data",
        
        "dojo/domReady!"
      ], 
      function(
        size, array, lang,
        basicData
      ) {
        
        window.size = size;
        
        //=================================================
        
        function compareThemes(actual, expected) {
          var result = false;
          
          if (actual && expected) {
            if (actual.length === expected.length) {
              
              result = array.every(expected, function(expTheme, idx) {
                var actTheme = actual[idx],
                    itemResult = false;              
                
                if (actTheme && expTheme) {
                  itemResult = (
                    (actTheme.name === expTheme.name) &&
                    (
                      actTheme.basemaps && expTheme.basemaps &&
                      actTheme.basemaps.sort().join(",") === expTheme.basemaps.sort().join(",")
                    )
                  );
                }
              
                return itemResult;
              });
              
            }
          }
          else {
            result = (actual === expected);
          }
          
          return result;
        }
        
        function runThemeTest(test) {
          // Run          
          var themes = size.getAvailableThemes.apply(size, test.params);
          
          // Evaluate
          var result = compareThemes(themes, test.expectedValue);
          
          console[result ? "info" : "error"](
            (result ? "pass" : "fail"), 
            themes
          );
        }
        
        console.log(" ");
        console.info("---[ THEME TESTS ]---");
        
        array.forEach(basicData.themeTests, function(test) {
          runThemeTest(test);
        });
        
        //=================================================
        
        function compareColor(actual, expected) {
          var result = false;
          
          if (actual && expected) {
            result = (
              actual.r === expected.r &&
              actual.g === expected.g &&
              actual.b === expected.b && 
              actual.a === expected.a
            );
          }
          else {
            result = (actual === expected);
          }
          
          return result;
        }
        
        function compareOutline(actual, expected) {
          var result = false;
          
          if (actual && expected) {
            result = (
              compareColor(actual.color, expected.color) &&
              actual.width === expected.width
            );
          }
          else {
            result = (actual === expected);
          }
          
          return result;
        }
        
        function comparePointScheme(actual, expected) {
          return (
            (actual.size === expected.size) && 
            (actual.noDataSize === expected.noDataSize) && 
            (actual.minSize === expected.minSize) && 
            (actual.maxSize === expected.maxSize) && 
            compareColor(actual.color, expected.color) && 
            compareColor(actual.noDataColor, expected.noDataColor) &&
            compareOutline(actual.outline, expected.outline)
          );
        }
        
        function compareLineScheme(actual, expected) {
          return (
            (actual.width === expected.width) && 
            (actual.noDataWidth === expected.noDataWidth) && 
            (actual.minWidth === expected.minWidth) && 
            (actual.maxWidth === expected.maxWidth) && 
            compareColor(actual.color, expected.color) &&
            compareColor(actual.noDataColor, expected.noDataColor)
          );
        }
        
        function comparePolygonScheme(actual, expected) {
          var markerResult = false, bgResult = false;
          
          if (actual.marker && expected.marker) {
            markerResult = comparePointScheme(actual.marker, expected.marker);
          }
          else {
            markerResult = (actual.marker === expected.marker);
          }
          
          if (actual.background && expected.background) {
            bgResult = ( 
              compareColor(actual.background.color, expected.background.color) && 
              compareOutline(actual.background.outline, expected.background.outline)
            );
          }
          else {
            bgResult = (actual.background === expected.background);
          }
          
          return (markerResult && bgResult);
        }
        
        function compareScheme(actual, expected, geomType) {
          var result = false;
          
          if (actual && expected) {
            switch(geomType) {
              case "point":
              case "esriGeometryPoint":
                result = comparePointScheme(actual, expected);
                break;
  
              case "line":
              case "esriGeometryPolyline":
                result = compareLineScheme(actual, expected);
                break;
  
              case "polygon":
              case "esriGeometryPolygon":
                result = comparePolygonScheme(actual, expected);
                break;
            }
          }
          else {
            result = (actual === expected);
          }
          
          return result;
        }
        
        function compareSchemes(actual, expected, geomType) {
          var result = false;
          
          if (actual && expected) {
            var primaryResult = compareScheme(actual.primaryScheme, expected.primaryScheme, geomType),
                secResult = false;
                
            if (actual.secondarySchemes && expected.secondarySchemes) {
              if (actual.secondarySchemes.length === expected.secondarySchemes.length) {
                secResult = array.every(expected.secondarySchemes, function(expScheme , idx) {
                  return compareScheme(actual.secondarySchemes[idx], expScheme, geomType);
                });
              }
            }
            else {
              secResult = (actual.secondarySchemes === expected.secondarySchemes);
            }
            
            result = primaryResult && secResult;
          }
          else {
            result = (actual === expected);
          }
          
          return result;
        }
        
        function runSchemeTest(test) {
          // Run          
          var schemes = size.getSchemes.apply(size, test.params);
          
          // Evaluate
          var result = compareSchemes(schemes, test.expectedValue, test.params[0].geometryType);
          
          console[result ? "info" : "error"](
            (result ? "pass" : "fail"), 
            schemes
          );
        }
        
        console.log(" ");
        console.info("---[ SCHEME TESTS ]---");
        
        array.forEach(basicData.schemeTests, function(test) {
          runSchemeTest(test);
        });
        
        //=================================================
  
        function runCloneSchemeTest(test) {
          // Run
          var scheme = size.cloneScheme.apply(size, test.params);
    
          // Evaluate
          var result = compareScheme(scheme, test.expectedValue, "polygon");
    
          console[result ? "info" : "error"](
            (result ? "pass" : "fail"),
            scheme
          );
        }
  
        console.log(" ");
        console.info("---[ CLONE-SCHEME TESTS ]---");
  
        array.forEach(basicData.cloneSchemeTests, function(test) {
          runCloneSchemeTest(test);
        });
  
        //=================================================
        
        console.log(" ");
        console.log("---[ DONE ]---");
        
      });

    </script>
  </head>

  <body>
    See browser console for test results.
  </body>
</html>
