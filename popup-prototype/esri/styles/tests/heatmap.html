<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Heatmap tests</title>

    <script>
      var dojoConfig = {
        isDebug: true,

        packages: [
          { name: "esri", location: "../esri" },
          {
            name: "tests",
            location: location.pathname.replace(/\/[^/]+$/, "")
          }
        ]
      };
    </script>
    <script type="text/javascript" src="../../../dojo/dojo.js"></script>

    <script>
      var heatmap;
      
      require([
        "esri/styles/heatmap",
        
        "dojo/_base/array",
        "dojo/_base/lang",
        
        "tests/heatmap-data",
        
        "dojo/domReady!"
      ], 
      function(
        heatmap, array, lang,
        heatmapData
      ) {
        
        window.heatmap = heatmap;
        
        //=================================================
        
        function compareThemes(actual, expected) {
          var result = false;
          
          if (actual && expected) {
            if (actual.length === expected.length) {
              
              result = array.every(expected, function(expTheme, idx) {
                var actTheme = actual[idx],
                    itemResult = false;              
                
                if (actTheme && expTheme) {
                  itemResult = (
                    (actTheme.name === expTheme.name) &&
                    (
                      actTheme.basemaps && expTheme.basemaps &&
                      actTheme.basemaps.sort().join(",") === expTheme.basemaps.sort().join(",")
                    )
                  );
                }
              
                return itemResult;
              });
              
            }
          }
          else {
            result = (actual === expected);
          }
          
          return result;
        }
        
        function runThemeTest(test) {
          // Run          
          var themes = heatmap.getAvailableThemes.apply(heatmap, test.params);
          
          // Evaluate
          var result = compareThemes(themes, test.expectedValue);
          
          console[result ? "info" : "error"](
            (result ? "pass" : "fail"), 
            themes
          );
        }
        
        console.log(" ");
        console.info("---[ THEME TESTS ]---");
        
        array.forEach(heatmapData.themeTests, function(test) {
          runThemeTest(test);
        });
        
        //=================================================
        
        function compareColor(actual, expected) {
          return (
            actual.r === expected.r &&
            actual.g === expected.g &&
            actual.b === expected.b && 
            actual.a === expected.a
          );
        }
        
        function compareColors(actual, expected) {
          var result = false;
          
          if (actual && expected) {
            if (actual.length === expected.length) {
              result = array.every(expected, function(expColor, idx) {
                return compareColor(actual[idx], expColor);
              });
            }
          }
          else {
            result = (actual === expected);
          }
          
          return result;
        }
        
        
        function compareScheme(actual, expected) {
          var result = false;
          
          if (actual && expected) {
            result = compareColors(actual.colors, expected.colors);
          }
          else {
            result = (actual === expected);
          }
          
          return result;
        }
        
        function compareSchemes(actual, expected) {
          var result = false;
          
          if (actual && expected) {
            var primaryResult = compareScheme(actual.primaryScheme, expected.primaryScheme),
                secResult = false;
                
            if (actual.secondarySchemes && expected.secondarySchemes) {
              if (actual.secondarySchemes.length === expected.secondarySchemes.length) {
                secResult = array.every(expected.secondarySchemes, function(expScheme , idx) {
                  return compareScheme(actual.secondarySchemes[idx], expScheme);
                });
              }
            }
            else {
              secResult = (actual.secondarySchemes === expected.secondarySchemes);
            }
            
            result = primaryResult && secResult;
          }
          else {
            result = (actual === expected);
          }
          
          return result;
        }
        
        function runSchemeTest(test) {
          // Run          
          var schemes = heatmap.getSchemes.apply(heatmap, test.params);
          
          // Evaluate
          var result = compareSchemes(schemes, test.expectedValue);
          
          console[result ? "info" : "error"](
            (result ? "pass" : "fail"), 
            schemes
          );
        }
        
        console.log(" ");
        console.info("---[ SCHEME TESTS ]---");
        
        array.forEach(heatmapData.schemeTests, function(test) {
          runSchemeTest(test);
        });
        
        //=================================================
  
        function runCloneSchemeTest(test) {
          // Run
          var scheme = heatmap.cloneScheme.apply(heatmap, test.params);
    
          // Evaluate
          var result = compareScheme(scheme, test.expectedValue);
    
          console[result ? "info" : "error"](
            (result ? "pass" : "fail"),
            scheme
          );
        }
  
        console.log(" ");
        console.info("---[ CLONE-SCHEME TESTS ]---");
  
        array.forEach(heatmapData.cloneSchemeTests, function(test) {
          runCloneSchemeTest(test);
        });
  
        //=================================================
        
        console.log(" ");
        console.log("---[ DONE ]---");
        
      });

    </script>
  </head>

  <body>
    See browser console for test results.
  </body>
</html>
