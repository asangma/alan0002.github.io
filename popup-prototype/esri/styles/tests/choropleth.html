<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Choropleth tests</title>

    <script>
      var dojoConfig = {
        isDebug: true,

        packages: [
          { name: "esri", location: "../esri" },
          {
            name: "tests",
            location: location.pathname.replace(/\/[^/]+$/, "")
          }
        ]
      };
    </script>
    <script type="text/javascript" src="../../../dojo/dojo.js"></script>

    <script>
      var choropleth;
      
      require([
        "esri/styles/choropleth",
        
        "dojo/_base/array",
        "dojo/_base/lang",
        
        "tests/choropleth-data",
        
        "dojo/domReady!"
      ], 
      function(
        choropleth, array, lang,
        choroplethData
      ) {
        
        window.choropleth = choropleth;
        
        //=================================================
        
        function compareThemes(actual, expected) {
          var result = false;
          
          if (actual && expected) {
            if (actual.length === expected.length) {
              
              result = array.every(expected, function(expTheme, idx) {
                var actTheme = actual[idx],
                    itemResult = false;              
                
                if (actTheme && expTheme) {
                  itemResult = (
                    (actTheme.name === expTheme.name) &&
                    (
                      actTheme.basemaps && expTheme.basemaps &&
                      actTheme.basemaps.sort().join(",") === expTheme.basemaps.sort().join(",")
                    )
                  );
                }
              
                return itemResult;
              });
              
            }
          }
          else {
            result = (actual === expected);
          }
          
          return result;
        }
        
        function runThemeTest(test) {
          // Run          
          var themes = choropleth.getAvailableThemes.apply(choropleth, test.params);
          
          // Evaluate
          var result = compareThemes(themes, test.expectedValue);
          
          console[result ? "info" : "error"](
            (result ? "pass" : "fail"), 
            themes
          );
        }
        
        console.log(" ");
        console.info("---[ THEME TESTS ]---");
        
        array.forEach(choroplethData.themeTests, function(test) {
          runThemeTest(test);
        });
        
        //=================================================
        
        function compareColor(actual, expected) {
          return (
            actual.r === expected.r &&
            actual.g === expected.g &&
            actual.b === expected.b && 
            actual.a === expected.a
          );
        }
        
        function compareColors(actual, expected) {
          var result = false;
          
          if (actual && expected) {
            if (actual.length === expected.length) {
              result = array.every(expected, function(expColor, idx) {
                return compareColor(actual[idx], expColor);
              });
            }
          }
          else {
            result = (actual === expected);
          }
          
          return result;
        }
        
        function compareColorsForBreaks(actual, expected) {
          var result = false;
          
          if (actual && expected) {
            if (actual.length === expected.length) {
              result = array.every(expected, function(expObj, idx) {
                return (
                  (actual[idx].numClasses === expObj.numClasses) &&
                  compareColors(actual[idx].colors, expObj.colors)
                );
              });
            }
          }
          else {
            result = (actual === expected);
          }
          
          return result;
        }
        
        function compareOutline(actual, expected) {
          var result = false;
          
          if (actual && expected) {
            result = (
              compareColor(actual.color, expected.color) &&
              actual.width === expected.width
            );
          }
          else {
            result = (actual === expected);
          }
          
          return result;
        }
        
        function comparePointScheme(actual, expected) {
          return (
            (actual.id === expected.id) &&
            (actual.theme === expected.theme) &&
            (actual.size === expected.size) && 
            compareColors(actual.colors, expected.colors) && 
            compareColorsForBreaks(actual.colorsForClassBreaks, expected.colorsForClassBreaks) && 
            compareColor(actual.noDataColor, expected.noDataColor) &&
            compareOutline(actual.outline, expected.outline)
          );
        }
        
        function compareLineScheme(actual, expected) {
          return (
            (actual.id === expected.id) &&
            (actual.theme === expected.theme) &&
            (actual.width === expected.width) && 
            compareColors(actual.colors, expected.colors) && 
            compareColorsForBreaks(actual.colorsForClassBreaks, expected.colorsForClassBreaks) &&
            compareColor(actual.noDataColor, expected.noDataColor)
          );
        }
        
        function comparePolygonScheme(actual, expected) {
          return (
            (actual.id === expected.id) &&
            (actual.theme === expected.theme) &&
            compareColors(actual.colors, expected.colors) && 
            compareOutline(actual.outline, expected.outline) && 
            compareColorsForBreaks(actual.colorsForClassBreaks, expected.colorsForClassBreaks) &&
            compareColor(actual.noDataColor, expected.noDataColor)
          );
        }
        
        function compareScheme(actual, expected, geomType) {
          var result = false;
          
          if (actual && expected) {
            switch(geomType) {
              case "point":
              case "esriGeometryPoint":
                result = comparePointScheme(actual, expected);
                break;
  
              case "line":
              case "esriGeometryPolyline":
                result = compareLineScheme(actual, expected);
                break;
  
              case "polygon":
              case "esriGeometryPolygon":
                result = comparePolygonScheme(actual, expected);
                break;
            }
          }
          else {
            result = (actual === expected);
          }
          
          return result;
        }
        
        function compareSchemes(actual, expected, geomType) {
          var result = false;
          
          if (actual && expected) {
            var primaryResult = compareScheme(actual.primaryScheme, expected.primaryScheme, geomType),
                secResult = false;
                
            if (actual.secondarySchemes && expected.secondarySchemes) {
              if (actual.secondarySchemes.length === expected.secondarySchemes.length) {
                secResult = array.every(expected.secondarySchemes, function(expScheme , idx) {
                  return compareScheme(actual.secondarySchemes[idx], expScheme, geomType);
                });
              }
            }
            else {
              secResult = (actual.secondarySchemes === expected.secondarySchemes);
            }
            
            result = primaryResult && secResult;
          }
          else {
            result = (actual === expected);
          }
          
          return result;
        }
        
        function runSchemeTest(test) {
          // Run          
          var schemes = choropleth.getSchemes.apply(choropleth, test.params);
          
          // Evaluate
          var result = compareSchemes(schemes, test.expectedValue, test.params[0].geometryType);
          
          console[result ? "info" : "error"](
            (result ? "pass" : "fail"), 
            schemes
          );
        }
        
        console.log(" ");
        console.info("---[ SCHEME TESTS ]---");
        
        array.forEach(choroplethData.schemeTests, function(test) {
          runSchemeTest(test);
        });
        
        //=================================================

        function runSchemeByIdTest(test) {
          // Run
          var scheme = choropleth.getSchemeById.apply(choropleth, test.params);

          // Evaluate
          var result = compareScheme(scheme, test.expectedValue, test.params[0].geometryType);

          console[result ? "info" : "error"](
            (result ? "pass" : "fail"),
            scheme
          );
        }

        console.log(" ");
        console.info("---[ SCHEME-BY-ID TESTS ]---");

        array.forEach(choroplethData.schemeByIdTests, function(test) {
          runSchemeByIdTest(test);
        });

        //=================================================

        function runCloneSchemeTest(test) {
          // Run
          var scheme = choropleth.cloneScheme.apply(choropleth, test.params);

          // Evaluate
          var result = compareScheme(scheme, test.expectedValue, "point");

          console[result ? "info" : "error"](
            (result ? "pass" : "fail"),
            scheme
          );
        }

        console.log(" ");
        console.info("---[ CLONE-SCHEME TESTS ]---");

        array.forEach(choroplethData.cloneSchemeTests, function(test) {
          runCloneSchemeTest(test);
        });

        //=================================================
        
        function compareSchemesList(actual, expected, geomType) {
          var result = false;
          
          if (actual && expected) {
            if (actual.length === expected.length) {
              result = array.every(expected, function(expScheme, idx) {
                return compareScheme(actual[idx], expScheme, geomType);
              });
            }
          }
          else {
            result = (actual === expected);
          }
          
          return result;
        }

        function runMatchingSchemesTest(test) {
          // Run
          var schemes = choropleth.getMatchingSchemes.apply(choropleth, test.params);

          // Evaluate
          var result = compareSchemesList(schemes, test.expectedValue, "point");

          console[result ? "info" : "error"](
            (result ? "pass" : "fail"),
            schemes
          );
        }

        console.log(" ");
        console.info("---[ MATCHIHNG-SCHEMES TESTS ]---");

        array.forEach(choroplethData.matchingSchemesTests, function(test) {
          runMatchingSchemesTest(test);
        });

        //=================================================

        console.log(" ");
        console.log("---[ DONE ]---");
        
      });

    </script>
  </head>

  <body>
    See browser console for test results.
  </body>
</html>
