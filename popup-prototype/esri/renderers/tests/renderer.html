<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Renderer tests</title>

    <script>
      var dojoConfig = {
        isDebug: true,

        packages: [
          { name: "esri", location: "../esri" }
        ]
      };
    </script>
    <script type="text/javascript" src="../../../dojo/dojo.js"></script>

    <script>
      var renderer, graphic;
      
      require([
        "esri/renderers/SimpleRenderer",
        "esri/symbols/SimpleMarkerSymbol",
        "esri/Color",
        "esri/Graphic",
        "esri/geometry/Point",
        
        "dojo/_base/array",
        "dojo/_base/lang",
        
        "dojo/domReady!"
      ], 
      function(SimpleRenderer, SimpleMarkerSymbol, Color, Graphic, Point, array, lang) {
        
        renderer = new SimpleRenderer(
          new SimpleMarkerSymbol().setColor(new Color([156, 0, 21, 1]))
        );
        
        graphic = new Graphic(
          new Point(0, 0), // geometry
          null,            // symbol
          {}               // attributes
        );
        
        function cloneRenderer(rnd) {
          rnd = rnd.toJson();
          rnd = new SimpleRenderer(rnd);
          return rnd;
        }
        
        //=================================================
        
        function compareSize(actual, expected) {
          return (actual === expected);
        }
        
        function runSizeTest(renderer, graphic, sizeInfo, test, isClone) {
          // Run          
          var size = renderer.getSize(graphic);
          
          // Evaluate
          var result = compareSize(size, test.expectedValue);
          
          console[result ? "info" : "error"](
            (isClone ? "  (clone)" : ""),
            (result ? "pass" : "fail"), 
            size,
            (sizeInfo.valueUnit && sizeInfo.valueUnit !== "unknown") ? "meters" : "px"
          );
        }
        
        console.log(" ");
        console.info("---[ SIZE TESTS ]---");
        
        var sizeTests = [
          // CONSTANT size
          {
            info: {
              minSize: 10
            },
            fieldValue: "field value does not matter",
            expectedValue: 10
          },
          
          // ATTRIBUTE driven: KNOWN unit
          {
            info: {
              field: "canopyM",
              valueUnit: "meters"
            },
            fieldValue: 123,
            expectedValue: 123
          },
          
          {
            info: {
              field: "canopyKM",
              valueUnit: "kilometers"
            },
            fieldValue: 9876,
            expectedValue: 9876000
          },
          
          // ATTRIBUTE driven: KNOWN unit
          // * valueRepresentation
          {
            info: {
              field: "canopyM",
              valueUnit: "meters",
              valueRepresentation: "radius"
            },
            fieldValue: 123,
            expectedValue: 123 * 2
          },
          
          {
            info: {
              field: "canopyM",
              valueUnit: "meters",
              valueRepresentation: "distance"
            },
            fieldValue: 123,
            expectedValue: 123 * 2
          },
          
          {
            info: {
              field: "canopyM",
              valueUnit: "meters",
              valueRepresentation: "diameter"
            },
            fieldValue: 123,
            expectedValue: 123
          },
          
          {
            info: {
              field: "canopyM",
              valueUnit: "meters",
              valueRepresentation: "width"
            },
            fieldValue: 123,
            expectedValue: 123
          },
          
          {
            info: {
              field: "canopyM",
              valueUnit: "meters",
              valueRepresentation: "height"
            },
            fieldValue: 123,
            expectedValue: 123
          },
          
          // Field value is area recorded in square meters.
          {
            info:{
              field: "canopyAreaSqM",
              valueUnit: "meters",
              valueRepresentation: "area"
            },
            fieldValue: 314.1592653589793,
            expectedValue: 20
          },
          
          // ATTRIBUTE driven: UNKNOWN unit
          // * Linear interpolation bound by data and size ranges
          {
            info: {
              field: "populationLTMin",
              valueUnit: "unknown",
              minDataValue: 523174,
              maxDataValue: 37483448,
              minSize: 10,
              maxSize: 100
            },
            fieldValue: 100,
            expectedValue: 10
          },
          
          {
            info: {
              field: "populationEQMin",
              valueUnit: "unknown",
              minDataValue: 523174,
              maxDataValue: 37483448,
              minSize: 10,
              maxSize: 100
            },
            fieldValue: 523174,
            expectedValue: 10
          },
          
          {
            info: {
              field: "population",
              valueUnit: "unknown",
              minDataValue: 523174,
              maxDataValue: 37483448,
              minSize: 10,
              maxSize: 100
            },
            fieldValue: 1000000,
            expectedValue: 11.161093665052375
          },
          
          {
            info: {
              field: "populationEQMax",
              valueUnit: "unknown",
              minDataValue: 523174,
              maxDataValue: 37483448,
              minSize: 10,
              maxSize: 100
            },
            fieldValue: 37483448,
            expectedValue: 100
          },
          
          {
            info: {
              field: "populationGTMax",
              valueUnit: "unknown",
              minDataValue: 523174,
              maxDataValue: 37483448,
              minSize: 10,
              maxSize: 100
            },
            fieldValue: 500000000,
            expectedValue: 100
          },

          // ATTRIBUTE driven: UNKNOWN unit
          // * Unbound scaling using just minDataValue and minSize
          {
            info: {
              field: "population",
              valueUnit: "unknown",
              minDataValue: 523174,
              minSize: 10
            },
            fieldValue: 1000000,
            expectedValue: 19.114099706789712
          }
        ];
        
        array.forEach(sizeTests, function(test) {
          var sizeInfo = test.info;
          
          // Setup
          graphic.attributes[sizeInfo.field] = test.fieldValue;
          renderer.setSizeInfo(sizeInfo);

          runSizeTest(renderer, graphic, sizeInfo, test);
        });

        array.forEach(sizeTests, function(test) {
          var sizeInfo = test.info;
          
          // Setup
          graphic.attributes[sizeInfo.field] = test.fieldValue;
          renderer.setSizeInfo(sizeInfo);

          runSizeTest(cloneRenderer(renderer), graphic, sizeInfo, test, true);
        });
        
        //=================================================
        
        function compareColor(actual, expected) {
          return (
            actual.r === expected[0] &&
            actual.g === expected[1] &&
            actual.b === expected[2] && 
            actual.a === expected[3]
          );
        }
        
        function runColorTest(renderer, graphic, test, isClone) {
          // Run          
          var color = renderer.getColor(graphic);
          
          // Evaluate
          var result = compareColor(color, isClone ? test.expectedAfterClone : test.expectedValue);
          
          console[result ? "info" : "error"](
            (isClone ? "  (clone)" : ""),
            result ? "pass" : "fail", 
            color
          );
        }
        
        console.log(" ");
        console.info("---[ COLOR TESTS ]---");
        
        var colorTests = [
          {
            info: {
              colors: [
                [ 255, 128, 64, 0.5 ]
                // 0.5 morphs into 0.5019607843137255 after:
                //  (1) Serialize - toJSONColor does rounding
                //  (2) De-serialize - toDojoColor
                // 0.5 + (1/255)/(1/( Math.round(0.5 * 255) - (0.5 * 255) ))
              ]
            },
            fieldValue: "field value does not matter",
            expectedValue: [ 255, 128, 64, 0.5 ],
            expectedAfterClone: [ 255, 128, 64, 0.5019607843137255 ]
          },

          {
            info: {
              field: "population",
              minDataValue: 523174,
              maxDataValue: 37483448,
              colors: [
                [ 255, 0,   0, 0 ],
                [ 0,   255, 0, 1 ]
              ]
            },
            fieldValue: 1000000,
            expectedValue: [ 252, 3, 0, 0.012901040722804165 ],
            expectedAfterClone: [ 252, 3, 0, 0.012901040722804165 ]
          },

          {
            info: {
              field: "population",
              stops: [
                { value: 523174,   color: [ 255, 0,   0, 0 ] },
                { value: 37483448, color: [ 0,   255, 0, 1 ] }
              ]
            },
            fieldValue: 1000000,
            expectedValue: [ 252, 3, 0, 0.012901040722804165 ],
            expectedAfterClone: [ 252, 3, 0, 0.012901040722804165 ]
          },

          {
            info: {
              field: "population",
              stops: [
                { value: 523174,   color: [ 255, 0,   0,   0 ] },
                { value: 1000000,  color: [ 0,   255, 0,   0.5 ] },
                { value: 37483448, color: [ 0,   0,   255, 1 ] }
              ]
            },
            fieldValue: 5000000,
            // 0.5 + ((1-0.5) * ((5000000-1000000)/(37483448 - 1000000))) 
            //   = 0.5548193800103542
            expectedValue: [ 0, 227, 28, 0.5548193800103542 ],
            // 0.5019607843137255 + ((1-0.5019607843137255) * ((5000000-1000000)/(37483448 - 1000000)))
            //   = 0.5565651863632548 
            expectedAfterClone: [ 0, 227, 28, 0.5565651863632548 ]
          },

          {
            info: {
              field: "populationRANK",
              minDataValue: 1,
              maxDataValue: 10,
              colors: [
                [ 0,   255, 0, 1 ],
                [ 255, 0,   0, 0 ]
              ]
            },
            fieldValue: 6,
            expectedValue: [ 142, 113, 0, 0.4444444444444444 ],
            expectedAfterClone: [ 142, 113, 0, 0.4444444444444444 ]
          },

          {
            info: {
              field: "populationRANK",
              stops: [
                { value: 1,  color: [ 0,   0,   255, 1 ] },
                { value: 4,  color: [ 0,   255, 0,   0.5 ] },
                { value: 10, color: [ 255, 0,   0,   0 ] }
              ]
            },
            fieldValue: 6,
            // 0.5 + ((0-0.5) * ((6-4)/(10 - 4)))
            //   = 0.33333333333333337
            expectedValue: [ 85, 170, 0, 0.33333333333333337 ],
            // 0.5019607843137255 + ((0-0.5019607843137255) * ((6-4)/(10 - 4)))
            //   = 0.334640522875817
            expectedAfterClone: [ 85, 170, 0, 0.334640522875817 ]
          }
        ];
        
        array.forEach(colorTests, function(test) {
          var colorInfo = test.info;

          // Setup
          graphic.attributes[colorInfo.field] = test.fieldValue;
          renderer.setColorInfo(colorInfo);

          runColorTest(renderer, graphic, test);
        });
        
        array.forEach(colorTests, function(test) {
          var colorInfo = test.info;

          // Setup
          graphic.attributes[colorInfo.field] = test.fieldValue;
          renderer.setColorInfo(colorInfo);

          runColorTest(cloneRenderer(renderer), graphic, test, true);
        });

        //=================================================
        
        function compareOpacity(actual, expected) {
          return (actual === expected);
        }
        
        function runOpacityTest(renderer, graphic, test, isClone) {
          // Run          
          var opacity = renderer.getOpacity(graphic);
          
          // Evaluate
          var result = compareOpacity(opacity, test.expectedValue);
          
          console[result ? "info" : "error"](
            (isClone ? "  (clone)" : ""),
            result ? "pass" : "fail", 
            opacity
          );
        }
        
        console.log(" ");
        console.info("---[ OPACITY TESTS ]---");
        
        var opacityTests = [
          {
            info: {
              opacityValues: [ 0.5 ]
            },
            fieldValue: "field value does not matter",
            expectedValue: 0.5
          },
          
          {
            info: {
              field: "population",
              minDataValue: 523174,
              maxDataValue: 37483448,
              opacityValues: [ 0, 1 ]
            },
            fieldValue: 1000000,
            expectedValue: 0.012901040722804165
          },

          {
            info: {
              field: "population",
              stops: [
                { value: 523174,   opacity: 0 },
                { value: 37483448, opacity: 1 }
              ]
            },
            fieldValue: 1000000,
            expectedValue: 0.012901040722804165
          },

          {
            info: {
              field: "population",
              stops: [
                { value: 523174,   opacity: 0 },
                { value: 1000000,  opacity: 0.5 },
                { value: 37483448, opacity: 1 }
              ]
            },
            fieldValue: 5000000,
            expectedValue: 0.5548193800103542
          },

          // Decreasing opacity values
          {
            info: {
              field: "populationRANK",
              minDataValue: 1,
              maxDataValue: 10,
              opacityValues: [ 1, 0 ]
            },
            fieldValue: 6,
            expectedValue: 0.4444444444444444
          },

          {
            info: {
              field: "populationRANK",
              stops: [
                { value: 1,  opacity: 1 },
                { value: 4,  opacity: 0.5 },
                { value: 10, opacity: 0 }
              ]
            },
            fieldValue: 6,
            expectedValue: 0.33333333333333337
          }
        ];
        
        array.forEach(opacityTests, function(test) {
          var opacityInfo = test.info;

          // Setup
          graphic.attributes[opacityInfo.field] = test.fieldValue;
          renderer.setOpacityInfo(opacityInfo);

          runOpacityTest(renderer, graphic, test);
        });
        
        array.forEach(opacityTests, function(test) {
          var opacityInfo = test.info;

          // Setup
          graphic.attributes[opacityInfo.field] = test.fieldValue;
          renderer.setOpacityInfo(opacityInfo);

          runOpacityTest(cloneRenderer(renderer), graphic, test, true);
        });
        
        //=================================================
        
        function testVisualVariables(renderer, graphic, test, isClone) {
          // Run
          var values = renderer.getVisualVariableValues(graphic);
          
          // Evaluate
          array.forEach(values, function(item, idx) {
            var type = test.variables[idx].type, 
                result, suffix = "";
            
            if (type === "sizeInfo") {
              result = compareSize(item.value, test.expectedValues[idx]);
              suffix = (item.variable.valueUnit && item.variable.valueUnit !== "unknown") ? "meters" : "px";
            }
            else if (type === "colorInfo") {
              result = compareColor(item.value, isClone ? test.expectedAfterClone[idx] : test.expectedValues[idx]);
            }
            else if (type === "opacityInfo") {
              result = compareOpacity(item.value, test.expectedValues[idx]);
            }

            console[result ? "info" : "error"](
              (isClone ? "  (clone)" : ""),
              result ? "pass" : "fail", 
              item.value,
              suffix
            );
          });
        }

        console.log(" ");
        console.info("---[ VISUAL VARIABLES TESTS ]---");
        
        renderer.setSizeInfo(null);
        renderer.setColorInfo(null);
        renderer.setOpacityInfo(null);
        
        // Copy size/color/opacity tests into visual variables tests
        var visualVarsTests = [];
        
        array.forEach(sizeTests, function(test) {
          var variable = lang.clone(test.info);
          variable.type = "sizeInfo"; // Visual variables need "type"
          
          visualVarsTests.push({
            variables:      [ variable ],
            fieldValues:    [ test.fieldValue ],
            expectedValues: [ test.expectedValue ]
          });
        });

        array.forEach(colorTests, function(test) {
          var variable = lang.clone(test.info);
          variable.type = "colorInfo"; // Visual variables need "type"
          
          visualVarsTests.push({
            variables:      [ variable ],
            fieldValues:    [ test.fieldValue ],
            expectedValues: [ test.expectedValue ],
            expectedAfterClone: [ test.expectedAfterClone ]
          });
        });

        array.forEach(opacityTests, function(test) {
          var variable = lang.clone(test.info);
          variable.type = "opacityInfo"; // Visual variables need "type"
          
          visualVarsTests.push({
            variables:      [ variable ],
            fieldValues:    [ test.fieldValue ],
            expectedValues: [ test.expectedValue ]
          });
        });
        
        array.forEach(visualVarsTests, function(test) {
          var variables = test.variables, 
              fieldValues = test.fieldValues;
          
          // Setup
          array.forEach(test.variables, function(variable, idx) {
            graphic.attributes[variable.field] = fieldValues[idx];
          });
          
          renderer.setVisualVariables(variables);

          testVisualVariables(renderer, graphic, test);
        });
        
        array.forEach(visualVarsTests, function(test) {
          var variables = test.variables, 
              fieldValues = test.fieldValues;
          
          // Setup
          array.forEach(test.variables, function(variable, idx) {
            graphic.attributes[variable.field] = fieldValues[idx];
          });
          
          renderer.setVisualVariables(variables);

          testVisualVariables(cloneRenderer(renderer), graphic, test, true);
        });
        
        //=================================================
        
        console.log(" ");
        console.log("---[ DONE ]---");
        
      });

    </script>
  </head>

  <body>
    See browser console for test results.
  </body>
</html>
